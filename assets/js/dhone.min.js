function labelAddRemove(){map.getZoom()>7?popup.remove():map.getZoom()<7&&popup.addTo(map)}function switchLayer(layer){var layerId=layer.target.id;map.setStyle("mapbox://styles/batch21/"+layerId)}function iqr(k){return function(d,i){for(var q1=d.quartiles[0],q3=d.quartiles[2],iqr=(q3-q1)*k,i=-1,j=d.length;d[++i]<q1-iqr;);for(;d[--j]>q3+iqr;);return[i,j]}}function legendLanduseUpdate(){d3.select("#landuseCheckBox").on("click",function(){if(document.getElementById("landuseCheck").checked){legendLanduse.attr("height",200),d3.selectAll(".landuse").style("opacity",1),d3.selectAll(".village-boundaries").style("opacity",0);var landuses=legendLanduse.append("g").attr("class","landuseBox").attr("transform","translate(15,35)").selectAll("g").data(landuseScale.domain()).enter().append("g").attr("transform",function(d,i){var height=25,horz=0,vert=i*height;return"translate("+horz+","+vert+")"});landuses.append("rect").attr("width",15).attr("height",10).style("fill",landuseScale).style("stroke","black").style("stroke-width",.4),landuses.append("text").attr("x",30).attr("y",10).text(function(d){return d})}else 0==document.getElementById("landuseCheck").checked&&(d3.select(".landuseBox").remove(),d3.selectAll(".landuse").style("opacity",0),d3.selectAll(".village-boundaries").style("opacity",.5),legendLanduse.attr("height",25))})}function drawFeatures(){d3.json("/assets/data/dhone_landuse.json",function(landuse){svg_map.selectAll("path.features").data(landuse.features).enter().append("path").attr("d",path).attr("class","landuse").style("fill",function(d){return landuseScale(d.properties.descript)}).style("opacity",0).style("stroke","red").style("stroke-width",0),d3.json("/assets/data/village_areas.json",function(villages){svg_map.selectAll("path.features").data(villages.features).enter().append("path").attr("d",path).attr("class","village-boundaries").style("fill","#DF837D").style("opacity",.5).style("stroke","red").style("stroke-width",1.1).on("mouseover",function(d){d3.select(this).transition().duration(300).style("opacity",1).style("stroke-width",2),svg_map.append("text").attr("id","village_name").attr("x",parseFloat(projection([d.properties.lon_centre,d.properties.lat_centre])[0])-15).attr("y",parseFloat(projection([d.properties.lon_centre,d.properties.lat_centre])[1])-15).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(d.properties.name)}).on("mouseout",function(d){d3.select(this).transition().duration(100).style("opacity",.5).style("stroke-width",1.1),d3.select("#village_name").remove()});var villageLegend=legend.append("g").attr("id","boundaryLegend").attr("transform","translate(15,116)");villageLegend.append("rect").attr("width",15).attr("height",10).style("stroke","red").style("fill","#DF837D").style("opacity",.5).style("shape-rendering","auto"),villageLegend.append("text").attr("x",32).attr("y",10).text("Village areas").style("font-size","12px"),drawWells()}),legendLanduseUpdate()})}function drawWells(){d3.csv("/assets/data/dhone_wells.csv",function(data){wellData=data,wellCircles=svg_map.selectAll("circle").data(data).enter().append("circle").attr("cx",function(d){return projection([d.lon,d.lat])[0]}).attr("cy",function(d){return projection([d.lon,d.lat])[1]}).attr("r",function(d){return d.year<=startYear?3:0}).attr("class","well").attr("display","yes").style("fill",function(d){return d.depth?colorDepth(d.depth):"#ccc"}).style("opacity",.85).on("mouseover",function(d){d3.select(this).attr("r",8);var info=svg_map.append("svg").attr("class","tooltip").attr("height",66).attr("width",145).attr("x",function(){return d.lon<=77.83?projection([d.lon,d.lat])[0]-20:projection([d.lon,d.lat])[0]-100}).attr("y",function(){return projection([d.lon,d.lat])[1]-68}).append("g");info.append("rect").attr("class","wellInfoBox").attr("height",64).attr("width",143).attr("x",1).attr("y",1).attr("rx",10).attr("ry",10),info.append("text").attr("x",5).attr("y",15).style("font-size","12px").style("font-weight","bold").text(function(){return d.type}),info.append("text").attr("x",5).attr("y",30).style("font-size","11px").text(function(){return"Depth: "+d.depth+" metres"}),info.append("text").attr("x",5).attr("y",45).style("font-size","11px").text(function(){return"Status: "+d.status}),info.append("text").attr("x",5).attr("y",60).style("font-size","11px").text(function(){return d.year<1980?"Year constructed: ~"+d.year:"Year constructed: "+d.year})}).on("mouseout",function(){d3.select(this).attr("r",3),d3.select(".tooltip").remove()}),createCharts(),sliderActivate(),d3.select("#well-viz .glyphicon").attr("title","Play Animation"),d3.select(".playPause button").on("click",function(){"finished"===sliderStatus?(step=startYear-1,d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatus="playing",d3.select("#well-viz .glyphicon").attr("title","Pause Animation"),scrollTrig=!1,animate()):"paused"===sliderStatus?(d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatus="playing",d3.select("#well-viz .glyphicon").attr("title","Pause Animation"),scrollTrig=!1,animate()):(clearInterval(interval),d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-play"),sliderStatus="paused",d3.select("#well-viz .glyphicon").attr("title","Play Animation"),svg_map.selectAll(".well").transition().duration(yearDuration).attr("r",function(d){return d.year<=step?3:0}))})})}function updateLegend(buttonScale){legend.select("#legendGroup").remove(),legend.select("#wellTitle").remove(),legend.append("text").attr("x",48).attr("y",152).text(buttonText).attr("id","wellTitle").style("font-size","12px").style("font-weight","bold").style("text-decoration","underline"),wellLegend=legend.append("g").attr("id","legendGroup").attr("transform","translate(22,167)").selectAll("g").data(buttonScale.domain()).enter().append("g").attr("class","legend").attr("transform",function(d,i){var height=25,horz=0,vert=i*height;return"translate("+horz+","+vert+")"}),wellLegend.append("circle").attr("r",7).style("fill",buttonScale).style("stroke","black").style("stroke-width",.4),wellLegend.append("text").attr("x",25).attr("y",6).text(function(d){return buttonScale!==colorDepth?d:10===d?"0 - 10 metres":50===d?"10 - 50 metres":100===d?"50 - 100 metres":300===d?"100 + metres":void 0}).style("font-size","12px"),height=document.getElementById("legendBox").getBBox().height,d3.select("#legendSVG").attr("height",height+15)}function createButtons(){d3.select("#wellDepthButton").style("background-color","#FAE9BD").style("border-width","1px"),d3.selectAll(".buttonWells").on("mouseover",function(){d3.select(this).style("opacity",1).style("border-width","2px").style("margin"," 0px 4px 0px 0px")}).on("mouseout",function(){d3.select(this).style("opacity",.95).style("border-width","1px").style("margin","1px 5px 1px 1px")}).on("click",function(){buttonText=this.textContent,d3.selectAll(".buttonWells").style("background-color","#DDDDDD").style("border-width","1px"),d3.select(this).style("background-color","#FAE9BD").style("border-width","2px"),svg_map.selectAll(".well").style("fill",function(d){return"Well Type"===buttonText?d.type?colorType(d.type):"#ccc":"Well Depth"===buttonText?d.depth?colorDepth(d.depth):"#ccc":"Well Status (2012)"==buttonText&&d.status?colorStatus(d.status):"#ccc"}),"Well Depth"===buttonText?(updateLegend(colorDepth),d3.select(".legendLanduse").attr("id","landuse1")):"Well Type"===buttonText?(updateLegend(colorType),d3.select(".legendLanduse").attr("id","landuse2")):"Well Status (2012)"===buttonText&&(updateLegend(colorStatus),d3.select(".legendLanduse").attr("id","landuse1"))})}function createCharts(){var wellTypes=countWells("type",2012);xType.domain(d3.range(wellTypes.length)),yType.domain([0,280]),svg_type.append("g").attr("class","y axis").call(d3.svg.axis().scale(yType).orient("left").innerTickSize(-w2).outerTickSize(0).tickValues([40,80,120,160,200,240,280])),svg_type.append("g").attr("class","x axis").attr("transform","translate(0, "+h2+")").call(d3.svg.axis().scale(xType).orient("bottom").innerTickSize(0).outerTickSize(0).tickFormat(function(d){return wellTypes[d].key})).selectAll(".tick text").call(wrap,xType.rangeBand()),svg_type.append("text").attr("transform","rotate(-90)").attr("y",0-margin_bar.left+15).attr("x",0-h2/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.8px").text("Number of Wells"),wellTypes=countWells("type",startYear);var wellDepths=(svg_type.selectAll("rect").data(wellTypes).enter().append("rect").attr("selected","no").attr("class","bar").attr("x",function(d,i){return xType(i)}).attr("y",function(d){return yType(d.values)}).attr("width",xType.rangeBand()).attr("height",function(d){return h2-yType(d.values)}).style("fill",function(d){return"Open Well"==d.key?"#C4ED68":"Agricultural Borewell"==d.key?"#59A80F":"Domestic Borewell"==d.key?"#ba831f":void 0}).style("stroke","black").style("stroke-width",0).on("mouseover",function(d){"playing"!=sliderStatus&&(d3.select(this).style("fill",function(d){return"Open Well"==d.key?"#b9ea48":"Agricultural Borewell"==d.key?"#4a8d0c":"Domestic Borewell"==d.key?"#996c1a":void 0}),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&"yes"==this.getAttribute("display")&&d.key===j.type?3.5:0}),svg_type.append("text").attr("id","typetip").attr("x",parseInt(this.getAttribute("x"))+38).attr("y",parseInt(this.getAttribute("y"))-2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(Math.round(yType.invert(this.getAttribute("y")))))}).on("click",function(d){"playing"!=sliderStatus&&("no"==this.getAttribute("selected")?(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),d3.select(this).attr("selected","yes").style("stroke-width",3),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&d.key===j.type?3.5:0}).attr("display",function(j){return d.key===j.type?"yes":"no"})):"playing"!=sliderStatus&&(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),svg_map.selectAll(".well").attr("display","yes").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0})))}).on("mouseout",function(d){d3.select(this).style("fill",function(d){return"Open Well"==d.key?"#C4ED68":"Agricultural Borewell"==d.key?"#59A80F":"Domestic Borewell"==d.key?"#ba831f":void 0}),svg_map.selectAll(".well").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0}),d3.select("#typetip").remove()}),countWells("depth_bin",2012));xDepth.domain(d3.range(wellDepths.length)),yDepth.domain([0,280]),svg_depth.append("g").attr("class","y axis").call(d3.svg.axis().scale(yDepth).orient("left").innerTickSize(-w2).outerTickSize(0).tickValues([40,80,120,160,200,240,280])),svg_depth.append("g").attr("class","x axis").attr("transform","translate(0, "+h2+")").call(d3.svg.axis().scale(xDepth).orient("bottom").innerTickSize(0).outerTickSize(0).tickFormat(function(d){return wellDepths[d].key})),svg_depth.append("text").attr("transform","rotate(-90)").attr("y",0-margin_bar.left+15).attr("x",0-h2/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.8px").text("Number of Wells"),wellDepths=countWells("depth_bin",startYear);var wellStatus=(svg_depth.selectAll("rect").data(wellDepths).enter().append("rect").attr("class","bar").attr("selected","no").attr("x",function(d,i){return xDepth(i)}).attr("y",function(d){return yDepth(d.values)}).attr("width",xDepth.rangeBand()).attr("height",function(d){return h2-yDepth(d.values)}).style("fill",function(d){return"0 - 10 m"===d.key?"#c4d4e1":"10 - 50 m"===d.key?"#6baed6":"50 - 100 m"===d.key?"#2171b5":"100 m +"===d.key?"#08306b":void 0}).style("stroke","black").style("stroke-width",0).on("mouseover",function(d){"playing"!=sliderStatus&&(d3.select(this).style("fill",function(d){return"0 - 10 m"===d.key?"#aac2d4":"10 - 50 m"===d.key?"#4b9ece":"50 - 100 m"===d.key?"#1c5d97":"100 m +"===d.key?"#052047":void 0}),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&"yes"===this.getAttribute("display")&&d.key===j.depth_bin?3.5:0}),svg_depth.append("text").attr("id","depthtip").attr("x",parseInt(this.getAttribute("x"))+27.5).attr("y",parseInt(this.getAttribute("y"))-2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(Math.round(yType.invert(this.getAttribute("y")))))}).on("click",function(d){"playing"!=sliderStatus&&("no"===this.getAttribute("selected")?(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),d3.select(this).attr("selected","yes").style("stroke-width",2.5),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&d.key===j.depth_bin?3.5:0}).attr("display",function(j){return d.key===j.depth_bin?"yes":"no"})):(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),svg_map.selectAll(".well").attr("display","yes").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0})))}).on("mouseout",function(d){d3.select(this).style("fill",function(d){return"0 - 10 m"===d.key?"#c4d4e1":"10 - 50 m"===d.key?"#6baed6":"50 - 100 m"===d.key?"#2171b5":"100 m +"===d.key?"#08306b":void 0}),svg_map.selectAll(".well").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0}),d3.select("#depthtip").remove()}),countWells("status",2012));xStatus.domain(d3.range(wellStatus.length)),yStatus.domain([0,280]),svg_status.append("g").attr("class","y axis").call(d3.svg.axis().scale(yStatus).orient("left").innerTickSize(-w2).outerTickSize(0).tickValues([40,80,120,160,200,240,280])),svg_status.append("g").attr("class","x axis").attr("transform","translate(0, "+h2+")").call(d3.svg.axis().scale(xStatus).orient("bottom").innerTickSize(0).outerTickSize(0).tickFormat(function(d){return wellStatus[d].key})).selectAll(".tick text").call(wrap,xStatus.rangeBand()),svg_status.append("text").attr("transform","rotate(-90)").attr("y",0-margin_bar.left+15).attr("x",0-h2/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.8px").text("Number of Wells"),wellStatus=countWells("status",startYear);svg_status.selectAll("rect").data(wellStatus).enter().append("rect").attr("class","bar").attr("selected","no").attr("x",function(d,i){return xStatus(i)}).attr("y",function(d){return yStatus(d.values)}).attr("width",xStatus.rangeBand()).attr("height",function(d){return h2-yStatus(d.values)}).style("fill",function(d){return"Defunct"===d.key?"#784860":"Fails every summer"===d.key?"#C07860":"Fails during droughts"===d.key?"#F8CA8C":"Has never failed"===d.key?"#FFF4C2":void 0}).style("stroke","black").style("stroke-width",0).on("mouseover",function(d){"playing"!=sliderStatus&&(d3.select(this).style("fill",function(d){return"Defunct"===d.key?"#60394d":"Fails every summer"===d.key?"#b66449":"Fails during droughts"===d.key?"#f7bc6e":"Has never failed"===d.key?"#ffec99":void 0}),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&"yes"===this.getAttribute("display")&&d.key===j.status?3.5:0}),svg_status.append("text").attr("id","statustip").attr("x",parseInt(this.getAttribute("x"))+27.5).attr("y",parseInt(this.getAttribute("y"))-2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(Math.round(yType.invert(this.getAttribute("y")))))}).on("click",function(d){"playing"!=sliderStatus&&("no"===this.getAttribute("selected")?(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),d3.select(this).attr("selected","yes").style("stroke-width",2.5),svg_map.selectAll(".well").attr("r",function(j){return j.year<=slider.value()&&d.key===j.status?3.5:0}).attr("display",function(j){return d.key===j.status?"yes":"no"})):(d3.selectAll(".well-viz-charts .bar").attr("selected","no").style("stroke-width",0),svg_map.selectAll(".well").attr("display","yes").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0})))}).on("mouseout",function(d){d3.select(this).style("fill",function(d){return"Defunct"===d.key?"#784860":"Fails every summer"===d.key?"#C07860":"Fails during droughts"===d.key?"#F8CA8C":"Has never failed"===d.key?"#FFF4C2":void 0}),svg_map.selectAll(".well").attr("r",function(j){return"yes"===this.getAttribute("display")&&j.year<=slider.value()?3:0}),d3.select("#statustip").remove()});addLineChart()}function addLineChart(){d3.csv("/assets/data/dhone_wells_year_totals.csv",function(data){lineData=data,svg_line.append("g").attr("class","y axis").call(d3.svg.axis().scale(yline).orient("left").innerTickSize(-w4).outerTickSize(0).tickValues([100,200,300,400,500,600])),svg_line.append("g").attr("class","x axis").attr("transform","translate(0, "+h3+")").call(d3.svg.axis().scale(xline).orient("bottom").outerTickSize(0).tickFormat(d3.format("d")).tickValues([1970,1980,1990,2e3,2010])),svg_line.append("text").attr("transform","rotate(-90)").attr("y",0-margin_chart.left+25).attr("x",0-h3/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.8px").text("Number of Wells");var lineTotal=d3.svg.line().x(function(d){return xline(d.year)}).y(function(d){return yline(d.cumTotal)});svg_line.append("path").datum(data).attr("class","chartline").attr("d",lineTotal),svg_line.append("circle").attr("cx",function(){return xline(1980)}).attr("cy",function(d){return yline(86)}).attr("r",5).attr("id","well-total").style("fill","#B91E02").attr("stroke","black").attr("stroke-width",0).on("mouseover",function(){var point=this;d3.select(this).attr("stroke-width",1.1),svg_line.append("text").attr("id","linetip").attr("x",function(){return slider.value()<1985?parseInt(point.getAttribute("cx"))-50:parseInt(point.getAttribute("cx"))-70}).attr("y",function(){return slider.value()<1985?parseInt(point.getAttribute("cy"))-8:parseInt(point.getAttribute("cy"))-2}).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","#6A7368").text(Math.round(yline.invert(this.getAttribute("cy")))+" Wells"),svg_line.append("line").attr("id","guideline").attr("stroke","#800000").attr("stroke-width",1.1).attr("stroke-dasharray","3, 3").attr("x1",0).attr("x2",this.getAttribute("cx")-5).attr("y1",this.getAttribute("cy")).attr("y2",this.getAttribute("cy"))}).on("mouseout",function(){d3.select(this).attr("stroke-width",0),d3.select("#linetip").remove(),d3.select("#guideline").remove()}),svg_avDep.append("g").attr("class","y axis").call(d3.svg.axis().scale(yAvDep).orient("left").innerTickSize(-w4).outerTickSize(0).tickValues([10,20,30,40,50])),svg_avDep.append("g").attr("class","x axis").attr("transform","translate(0, "+h3+")").call(d3.svg.axis().scale(xAvDep).orient("bottom").tickFormat(d3.format("d")).outerTickSize(0).tickValues([1970,1980,1990,2e3,2010])),svg_avDep.append("text").attr("transform","rotate(-90)").attr("y",0-margin_chart.left+30).attr("x",0-h3/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.8px").text("Average depth (metres)");var lineAv=d3.svg.line().x(function(d){return xAvDep(d.year)}).y(function(d){return yAvDep(d.cumAv)});svg_avDep.append("path").datum(data).attr("class","chartline").attr("d",lineAv),svg_avDep.append("circle").attr("cx",function(){return xAvDep(1980)}).attr("cy",function(d){return yAvDep(9.8)}).attr("r",5).attr("id","well-avDep").style("fill","#B91E02").attr("stroke","black").attr("stroke-width",0).on("mouseover",function(){var point=this;d3.select(this).attr("stroke-width",1.1),svg_avDep.append("text").attr("id","avlinetip").attr("x",function(){return slider.value()<1985?parseInt(point.getAttribute("cx"))-50:parseInt(point.getAttribute("cx"))-70}).attr("y",function(){return slider.value()<1985?parseInt(point.getAttribute("cy"))-8:parseInt(point.getAttribute("cy"))-2}).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","#6A7368").text(Math.round(yAvDep.invert(this.getAttribute("cy")))+" metres"),svg_avDep.append("line").attr("id","guideline").attr("stroke","#800000").attr("stroke-width",1.1).attr("stroke-dasharray","3, 3").attr("x1",0).attr("x2",this.getAttribute("cx")-5).attr("y1",this.getAttribute("cy")).attr("y2",this.getAttribute("cy"))}).on("mouseout",function(){d3.select(this).attr("stroke-width",0),d3.select("#avlinetip").remove(),d3.select("#guideline").remove()})})}function updateLineChart(year){d3.select("#well-total").transition().duration(function(){return"playing"===sliderStatus?yearDuration:10}).attr("cx",function(){return xline(2013===year?2012:year)}).attr("cy",function(){for(var i=0;i<=lineData.length;i++){if(lineData[i].year==year)return yline(lineData[i].cumTotal);if(2013==year)return yline(573)}}),d3.select("#well-avDep").transition().duration(function(){return"playing"===sliderStatus?yearDuration:10}).attr("cx",function(){return xAvDep(2013===year?2012:year)}).attr("cy",function(){for(var i=0;i<=lineData.length;i++){if(lineData[i].year==year)return yAvDep(lineData[i].cumAv);if(2013==year)return yAvDep(49.7)}})}function countWells(attr,year){var nested=d3.nest().key(function(d){return d[attr]}).rollup(function(wellData){var count=d3.sum(wellData,function(d){if(d.year<=year)return d.count});return count}).entries(wellData);return nested}function sliderActivate(){slider.on("slide",function(evt,value){"playing"===sliderStatus?clearInterval(interval):"finished"===sliderStatus&&2013!=value&&(sliderStatus="paused",d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-play")),updateWells(value),updateLineChart(value),step=value}).on("slideend",function(evt,value){2013===value?(sliderStatus="finished",d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-repeat"),d3.select("#well-viz .glyphicon").attr("title","Replay Animation")):"playing"===sliderStatus&&animate()})}function wrap(text,width){text.each(function(){for(var word,text=d3.select(this),words=text.text().split(/\s+/).reverse(),line=[],lineNumber=0,lineHeight=1,y=text.attr("y"),dy=parseFloat(text.attr("dy")),tspan=text.text(null).append("tspan").attr("x",0).attr("y",y).attr("dy",dy+"em");word=words.pop();)line.push(word),tspan.text(line.join(" ")),tspan.node().getComputedTextLength()>width&&(line.pop(),tspan.text(line.join(" ")),line=[word],tspan=text.append("tspan").attr("x",0).attr("y",y).attr("dy",++lineNumber*lineHeight+dy+"em").text(word))})}function animate(){interval=setInterval(function(){step++,2013===step&&(clearInterval(interval),updateWells(step),updateLineChart(step),sliderStatus="finished",d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-repeat"),d3.select("#well-viz .glyphicon").attr("title","Replay Animation")),step<=2012&&(slider.value(step),updateWells(step),updateLineChart(step))},yearDuration)}function updateWells(year){year<2013&&d3.select("#slidertext").text(year),wellCircles.transition().duration(function(){return"playing"===sliderStatus?yearDuration:100}).attr("r",function(d){if("yes"===this.getAttribute("display"))return d.year===startYear?3:d.year==year&&"playing"===sliderStatus?8:d.year<year?3:0}),wellTypes=countWells("type",year),svg_type.selectAll("rect").data(wellTypes).transition().duration(yearDuration).attr("y",function(d){return yType(d.values)}).attr("height",function(d){return h2-yType(d.values)}),wellDepths=countWells("depth_bin",year),svg_depth.selectAll("rect").data(wellDepths).transition().duration(yearDuration).attr("y",function(d){return yDepth(d.values)}).attr("height",function(d){return h2-yDepth(d.values)}),wellStatus=countWells("status",year),svg_status.selectAll("rect").data(wellStatus).transition().duration(yearDuration).attr("y",function(d){return yStatus(d.values)}).attr("height",function(d){return h2-yStatus(d.values)})}function createWellVis(){drawFeatures(),updateLegend(colorDepth),createButtons()}function drawFeaturesRWH(){d3.json("/assets/data/village_areas.json",function(villages){svg_map_rwh.selectAll("path.features").data(villages.features).enter().append("path").attr("d",path).attr("class","village-boundaries").style("fill","#DF837D").style("opacity",.5).style("stroke","red").style("stroke-width",1.1).on("mouseover",function(d){d3.select(this).transition().duration(300).style("opacity",1).style("stroke-width",2),svg_map_rwh.append("text").attr("id","village_name_RWH").attr("x",parseFloat(projection([d.properties.lon_centre,d.properties.lat_centre])[0])-15).attr("y",parseFloat(projection([d.properties.lon_centre,d.properties.lat_centre])[1])-15).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(d.properties.name)}).on("mouseout",function(d){d3.select(this).transition().duration(100).style("opacity",.5).style("stroke-width",1.1),d3.select("#village_name_RWH").remove()});var villageLegendRWH=legendRWH.append("g").attr("id","villageLegend").attr("transform","translate(15,116)");villageLegendRWH.append("rect").attr("width",15).attr("height",10).style("stroke","red").style("fill","#DF837D").style("opacity",.5).style("shape-rendering","auto"),villageLegendRWH.append("text").attr("x",32).attr("y",10).text("Village areas").style("font-size","12px")})}function drawRWH(){d3.csv("/assets/data/dhone_rwh.csv",function(data){rwhData=data,rwhSymbols=svg_map_rwh.selectAll("path.features").data(data).enter().append("path").attr("transform",function(d){return"translate("+projection([d.lon,d.lat])[0]+","+projection([d.lon,d.lat])[1]+")"}).attr("d",d3.svg.symbol().size(function(d){return d.year<=startYearRWH?50:0}).type(function(d){return"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).attr("class","rwh").attr("display","yes").style("fill",function(d){return rwhTypeScale(d.type)}).style("stroke","#504A4B").style("stroke-width",1).style("opacity",.7).on("mouseover",function(d){d3.select(this).attr("d",d3.svg.symbol().size(function(d){return"RWH Capacity"!=buttonTextRWH?250:rwhSizeScale(d.Capacity)}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Tankk"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).style("opacity",1);var info=svg_map_rwh.append("svg").attr("class","tooltip").attr("height",66).attr("width",130).attr("x",function(){return d.lon<=77.83?projection([d.lon,d.lat])[0]:projection([d.lon,d.lat])[0]-100}).attr("y",function(){return projection([d.lon,d.lat])[1]-68}).append("g");info.append("rect").attr("class","rwhInfoBox").attr("height",64).attr("width",128).attr("x",1).attr("y",1).attr("rx",10).attr("ry",10),info.append("text").attr("x",5).attr("y",15).style("font-size","12px").style("font-weight","bold").text(function(){return d.type}),info.append("text").attr("x",5).attr("y",30).style("font-size","11px").text(function(){return"Capacity: "+commas(d.Capacity)+" "+cubedMetres}),info.append("text").attr("x",5).attr("y",45).style("font-size","11px").text(function(){return"Status: "+d.status}),info.append("text").attr("x",5).attr("y",60).style("font-size","11px").text(function(){return d.year<1980?"Year constructed: ~"+d.year:"Year constructed: "+d.year})}).on("mouseout",function(){d3.select(this).attr("d",d3.svg.symbol().size(function(d){return"RWH Capacity"!=buttonTextRWH?50:rwhSizeScale(d.Capacity)}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Tankk"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).style("opacity",.7),d3.select(".tooltip").remove()}),addBarChartsRWH(),addLineChartRWH(),SliderUpdateRWH()}),d3.select("#rwh-viz .glyphicon").attr("title","Play Animation"),d3.select(".playPauseRWH button").on("click",function(){"finished"===sliderStatusRWH?(stepRWH=startYearRWH-1,d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatusRWH="playing",d3.select("#rwh-viz .glyphicon").attr("title","Pause Animation"),scrollTrigRWH=!1,animateRWH()):"paused"===sliderStatusRWH?(d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatusRWH="playing",d3.select("#rwh-viz .glyphicon").attr("title","Pause Animation"),scrollTrigRWH=!1,animateRWH()):(clearInterval(intervalRWH),d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-play"),sliderStatusRWH="paused",d3.select("#rwh-viz .glyphicon").attr("title","Play Animation"),svg_map_rwh.selectAll(".rwh").transition().duration(yearDuration).attr("d",d3.svg.symbol().size(function(d){return d.year<=sliderRWH.value()&&"yes"==this.getAttribute("display")?"RWH Capacity"!=buttonTextRWH?50:rwhSizeScale(parseInt(d.Capacity)):0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})))})}function updateLegendRWH(buttonScale){legendRWH.select("#legendGroupRWH").remove(),legendRWH.select("#rwhTitle").remove();var totalCircleRadii=0;legendRWH.append("text").attr("x",function(){return"RWH Capacity"!=buttonTextRWH?48:60}).attr("y",150).text(buttonTextRWH).attr("id","rwhTitle").style("font-size","12px").style("font-weight","bold").style("text-decoration","underline"),strucLegend=legendRWH.append("g").attr("id","legendGroupRWH").attr("transform",function(){return"RWH Capacity"!=buttonTextRWH?"translate(22,162)":"translate(42,162)"}).selectAll("g").data(buttonScale.domain()).enter().append("g").attr("class","legendItem").attr("transform",function(d,i){if("RWH Capacity"!=buttonTextRWH){var height=22,horz=0,vert=i*height;return"translate("+horz+","+vert+")"}totalCircleRadii+=1.5*Math.sqrt(rwhSizeScale(d)/Math.PI);var height=9,horz=0,vert=i*height+totalCircleRadii;return"translate("+horz+","+vert+")"}),strucLegend.append("path").attr("d",d3.svg.symbol().size(function(d){return"RWH Capacity"!=buttonTextRWH?110:rwhSizeScale(d)}).type(function(d){return"Check Dam"===d?"square":"Infiltration Pond"===d?"circle":"Bund"===d?"triangle-up":void 0})).attr("fill",function(d){return"RWH Capacity"!=buttonTextRWH?buttonScale(d):"#96E1EB"}).style("opacity",.7).style("stroke","#504A4B").style("stroke-width",1),strucLegend.append("text").attr("x",function(){return"RWH Capacity"!=buttonTextRWH?25:60}).attr("y",6).text(function(d){return"RWH Capacity"!=buttonTextRWH?d:commas(d)+" "+cubedMetres}).style("font-size","12px"),height=document.getElementById("legendBoxRWH").getBBox().height,width=document.getElementById("legendBoxRWH").getBBox().width,d3.select("#legendSVG_RWH").attr("height",height+15).attr("width",width+10)}function activateButtonsRWH(){d3.select("#rwhTypeButton").style("background-color","#FAE9BD").style("border-width","1px"),d3.selectAll(".buttonRWH").on("mouseover",function(){d3.select(this).style("opacity",1).style("border-width","2px").style("margin","0px").style("margin"," 0px 4px 0px 0px")}).on("mouseout",function(){d3.select(this).style("opacity",.95).style("border-width","1px").style("margin","1px").style("margin","1px 5px 1px 1px")}).on("click",function(){buttonTextRWH=this.textContent,d3.selectAll(".buttonRWH").style("background-color","#DDDDDD").style("border-width","1px"),d3.select(this).style("background-color","#FAE9BD").style("border-width","2px"),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(d){return"yes"==this.getAttribute("display")&&d.year<=sliderRWH.value()?"RWH Capacity"!=buttonTextRWH?50:rwhSizeScale(d.Capacity):0;
}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).style("fill",function(d){return"RWH Type"===buttonTextRWH?d.type?rwhTypeScale(d.type):"#ccc":"RWH Status"===buttonTextRWH?d.status?rwhStatusScale(d.status):"#ccc":"RWH Capacity"===buttonTextRWH&&d.Capacity?"#96E1EB":"#ccc"}),"RWH Type"===buttonTextRWH?updateLegendRWH(rwhTypeScale):"RWH Status"===buttonTextRWH?updateLegendRWH(rwhStatusScale):"RWH Capacity"===buttonTextRWH&&updateLegendRWH(rwhSizeScale)})}function addBarChartsRWH(){var rwhTypes=countRWH("type",startYearRWH);xTypeRWH.domain(d3.range(Object.keys(rwhTypes).length)),yTypeRWH.domain([0,65]),rwh_type.append("g").attr("class","y axis").call(d3.svg.axis().scale(yTypeRWH).innerTickSize(-w5).outerTickSize(0).orient("left")),rwh_type.append("g").attr("class","x axis").attr("transform","translate(0, "+h4+")").call(d3.svg.axis().scale(xTypeRWH).orient("bottom").innerTickSize(0).outerTickSize(0).tickFormat(function(d){return rwhTypes[d].key})).selectAll(".tick text").call(wrap,xTypeRWH.rangeBand()),rwh_type.append("text").attr("transform","rotate(-90)").attr("y",0-margin_bar.left+15).attr("x",0-h4/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.6px").text("Number of structures"),rwh_type.selectAll("rect").data(rwhTypes).enter().append("rect").attr("selected","no").attr("class","bar").attr("x",function(d,i){return xTypeRWH(i)}).attr("y",function(d){return yTypeRWH(d.count)}).attr("width",xTypeRWH.rangeBand()).attr("height",function(d){return h4-yTypeRWH(d.count)}).style("fill",function(d){return"Check Dam"==d.key?"#BDBBC4":"Infiltration Pond"==d.key?"#5D9CA5":"Bund"==d.key?"#7a591f":void 0}).style("stroke","black").style("stroke-width",0).on("mouseover",function(d){d3.select(this).style("fill",function(d){return"Check Dam"==d.key?"#a2a0ac":"Infiltration Pond"==d.key?"#518b94":"Bund"==d.key?"#513b15":void 0}),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.type?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})),rwh_type.append("text").attr("id","typetipRWH").attr("x",parseInt(this.getAttribute("x"))+40.5).attr("y",parseInt(this.getAttribute("y"))-2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(Math.round(yTypeRWH.invert(this.getAttribute("y"))))}).on("click",function(d){"no"===this.getAttribute("selected")?(d3.selectAll("#rwh-viz-charts .bar").attr("selected","no").style("stroke-width",0),d3.select(this).attr("selected","yes").style("stroke-width",2.5),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.type?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).attr("display",function(j){return d.key===j.type?"yes":"no"})):(d3.selectAll("#rwh-viz-charts .bar").attr("selected","no").style("stroke-width",0),svg_map_rwh.selectAll(".rwh").attr("display","yes").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.type?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})))}).on("mouseout",function(d){d3.select(this).style("fill",function(d){return"Check Dam"==d.key?"#BDBBC4":"Infiltration Pond"==d.key?"#5D9CA5":"Bund"==d.key?"#7a591f":void 0}),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})),d3.select("#typetipRWH").remove()});var rwhStatus=countRWH("status",startYearRWH);xStatusRWH.domain(d3.range(Object.keys(rwhTypes).length)),yStatusRWH.domain([0,65]),rwh_status.append("g").attr("class","y axis").call(d3.svg.axis().scale(yStatusRWH).innerTickSize(-w5).outerTickSize(0).orient("left")),rwh_status.append("g").attr("class","x axis").attr("transform","translate(0, "+h4+")").call(d3.svg.axis().scale(xStatusRWH).orient("bottom").innerTickSize(0).outerTickSize(0).tickFormat(function(d){return rwhStatus[d].key})).selectAll(".tick text").call(wrap,xStatusRWH.rangeBand()),rwh_status.append("text").attr("transform","rotate(-90)").attr("y",0-margin_bar.left+18).attr("x",0-h4/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.6px").text("Number of structures"),rwh_status.selectAll("rect").data(rwhStatus).enter().append("rect").attr("selected","no").attr("class","bar").attr("x",function(d,i){return xStatusRWH(i)}).attr("y",function(d){return yStatusRWH(d.count)}).attr("width",xStatusRWH.rangeBand()).attr("height",function(d){return h4-yStatusRWH(d.count)}).style("fill",function(d){return"Good Condition"==d.key?"#2C7BB6":"Damaged"==d.key?"#FDAE61":"Destroyed"==d.key?"#D7191C":void 0}).style("stroke","black").style("stroke-width",0).on("mouseover",function(d){d3.select(this).style("fill",function(d){return"Good Condition"==d.key?"#236190":"Damaged"==d.key?"#fd9935":"Destroyed"==d.key?"#b71518":void 0}),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.status?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})),rwh_status.append("text").attr("id","statustipRWH").attr("x",parseInt(this.getAttribute("x"))+40.5).attr("y",parseInt(this.getAttribute("y"))-2).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","black").text(Math.round(yTypeRWH.invert(this.getAttribute("y"))))}).on("click",function(d){"no"===this.getAttribute("selected")?(d3.selectAll("#rwh-viz-charts .bar").attr("selected","no").style("stroke-width",0),d3.select(this).attr("selected","yes").style("stroke-width",2.5),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.status?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})).attr("display",function(j){return d.key===j.status?"yes":"no"})):(d3.selectAll("#rwh-viz-charts .bar").attr("selected","no").style("stroke-width",0),svg_map_rwh.selectAll(".rwh").attr("display","yes").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")&&d.key===j.status?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})))}).on("mouseout",function(d){d3.select(this).style("fill",function(d){return"Good Condition"==d.key?"#2C7BB6":"Damaged"==d.key?"#FDAE61":"Destroyed"==d.key?"#D7191C":void 0}),svg_map_rwh.selectAll(".rwh").attr("d",d3.svg.symbol().size(function(j){return j.year<=sliderRWH.value()&&"yes"===this.getAttribute("display")?"RWH Capacity"==buttonTextRWH?rwhSizeScale(j.Capacity):50:0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})),d3.select("#statustipRWH").remove()})}function addLineChartRWH(){d3.csv("/assets/data/dhone_rwh_cumulative_capacity.csv",function(data){capacityData=data,rwh_capacity.append("g").attr("class","y axis").call(d3.svg.axis().scale(ylineRWH).innerTickSize(-w3).outerTickSize(0).orient("left").tickValues([1e4,2e4,3e4,4e4,5e4,6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4])),rwh_capacity.append("g").attr("class","x axis").attr("transform","translate(0, "+h4+")").call(d3.svg.axis().scale(xlineRWH).orient("bottom").outerTickSize(0).ticks([15]).tickFormat(d3.format("d"))),rwh_capacity.append("text").attr("transform","rotate(-90)").attr("y",0-margin_line.left+15).attr("x",0-h4/2).style("text-anchor","middle").style("font-size","14px").style("font-weight","bold").style("letter-spacing","1.2px").text("Total Capacity ("+cubedMetres+")");var lineCapacity=d3.svg.line().x(function(d){return xlineRWH(d.year)}).y(function(d){return ylineRWH(d.all)});rwh_capacity.append("path").datum(data).attr("class","chartline").attr("d",lineCapacity),rwh_capacity.append("text").attr("x",xlineRWH(2005)).attr("y",ylineRWH(capacityData[8].all)-3).style("font-size","12px").text("All Structures"),secondarylines(rwhTypeScaleLine),d3.selectAll("#line-menu input").on("click",function(d){d3.selectAll(".secondayLineText").remove(),d3.selectAll(".secondaryLine").remove(),"status"==this.id?secondarylines(rwhStatusScale):"type"==this.id&&secondarylines(rwhTypeScaleLine)}),rwh_capacity.append("circle").attr("cx",function(){return xlineRWH(startYearRWH)}).attr("cy",function(d){return ylineRWH(65549)}).attr("r",5).attr("id","total-capacity").style("fill","#B91E02").attr("stroke","black").attr("stroke-width",0).on("mouseover",function(){var point=this;d3.select(this).attr("stroke-width",1.1),rwh_capacity.append("text").attr("id","linetip").attr("x",function(){return sliderRWH.value()<2006?parseInt(point.getAttribute("cx"))+5:parseInt(point.getAttribute("cx"))-75}).attr("y",function(){return sliderRWH.value()<2006?parseInt(point.getAttribute("cy"))+15:parseInt(point.getAttribute("cy"))-2}).attr("text-anchor","left").attr("font-family","sans-serif").attr("font-size","14px").attr("font-weight","bold").attr("fill","#6A7368").text(function(){return commas(Math.round(ylineRWH.invert(point.getAttribute("cy"))))+" "+cubedMetres}),rwh_capacity.append("line").attr("id","guideline").attr("stroke","#BDBBC4").attr("stroke-width",1.1).attr("stroke-dasharray","3, 3").attr("x1",0).attr("x2",this.getAttribute("cx")-5).attr("y1",this.getAttribute("cy")).attr("y2",this.getAttribute("cy"))}).on("mouseout",function(){d3.select(this).attr("stroke-width",0),d3.select("#linetip").remove(),d3.select("#guideline").remove()})})}function secondarylines(scale){for(var i=0;i<scale.domain().length;i++){rwh_capacity.append("text").attr("x",xlineRWH(2005)).attr("y",ylineRWH(capacityData[8][scale.domain()[i]])-3).style("font-size","12px").attr("class","secondayLineText").text(function(){return scale.domain()==rwhTypeScaleLine.domain()?rwhNames[i]:scale.domain()[i]});var line=d3.svg.line().x(function(d){return xlineRWH(d.year)}).y(function(d){return ylineRWH(d[scale.domain()[i]])});rwh_capacity.append("path").datum(capacityData).attr("class","secondaryLine").attr("d",line).style("stroke",function(){return scale.range()[i]})}}function SliderUpdateRWH(){sliderRWH.on("slide",function(evt,value){"playing"===sliderStatusRWH?clearInterval(intervalRWH):"finished"===sliderStatusRWH&&2012!=value&&(sliderStatusRWH="paused",d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-play")),stepRWH=value,updateRWH(value)}).on("slideend",function(evt,value){2012==value?(sliderStatusRWH="finished",d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-repeat"),d3.select("#rwh-viz .glyphicon").attr("title","Replay Animation")):"playing"===sliderStatusRWH&&animateRWH()})}function animateRWH(){intervalRWH=setInterval(function(){stepRWH++,stepRWH>2012?(clearInterval(intervalRWH),sliderStatusRWH="finished",d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-repeat"),d3.select("#rwh-viz .glyphicon").attr("title","Replay Animation"),updateRWH(stepRWH)):(sliderRWH.value(stepRWH),updateRWH(stepRWH))},yearDuration)}function updateRWH(year){svg_map_rwh.selectAll(".rwh").transition().duration(function(){return"playing"===sliderStatusRWH?yearDuration:100}).attr("d",d3.svg.symbol().size(function(d){return d.year<=year&&"yes"==this.getAttribute("display")?"RWH Capacity"!=buttonTextRWH?d.year==startYearRWH?50:d.year==year&&"playing"===sliderStatusRWH?500:d.year<year?50:0:rwhSizeScale(parseInt(d.Capacity)):0}).type(function(d){return"RWH Type"!=buttonTextRWH?"circle":"Check Dam"===d.type?"square":"Infiltration Pond"===d.type?"circle":"Bund"===d.type?"triangle-up":void 0})),rwhTypes=countRWH("type",year),rwh_type.selectAll("rect").data(rwhTypes).transition().duration(function(){return"playing"==sliderStatusRWH?yearDuration:100}).attr("y",function(d){return yTypeRWH(d.count)}).attr("height",function(d){return h4-yTypeRWH(d.count)}),rwhStatus=countRWH("status",year),rwh_status.selectAll("rect").data(rwhStatus).transition().duration(function(){return"playing"==sliderStatusRWH?yearDuration:100}).attr("y",function(d){return yStatusRWH(d.count)}).attr("height",function(d){return h4-yStatusRWH(d.count)}),year<2013&&d3.select("#total-capacity").transition().duration(function(){return"playing"==sliderStatusRWH?yearDuration:100}).attr("cx",function(){return xlineRWH(year)}).attr("cy",function(){for(var i=0;i<=capacityData.length;i++)if(capacityData[i].year==year)return ylineRWH(capacityData[i].all)})}function countRWH(column,year){for(var counts={},i=0;i<rwhData.length;i++)rwhData[i].year<=year&&(counts[rwhData[i][column]]=1+(counts[rwhData[i][column]]||0));objects=[];for(i in counts)entry={},entry.key=i,entry.count=counts[i],objects.push(entry);return objects}mapboxgl.accessToken="pk.eyJ1IjoiYmF0Y2gyMSIsImEiOiJQUDEzTDBzIn0.49sCQ1PnCzCwXO1L8w51Ug";var map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v9",center:[78.6757,18.9209],zoom:3.8});mapboxgl.accessToken="pk.eyJ1IjoiYmF0Y2gyMSIsImEiOiJQUDEzTDBzIn0.49sCQ1PnCzCwXO1L8w51Ug";var map=new mapboxgl.Map({container:"map",style:"mapbox://styles/batch21/ciqw43rbk000bcbmbwohidax7",center:[78.6757,18.9209],zoom:3.5});map.addControl(new mapboxgl.Navigation),map.scrollZoom.disable(),map.on("style.load",function(){map.addSource("villageBoundary",{type:"geojson",data:"/assets/data/dhone_area.json"}),map.addLayer({id:"revenue-village-boundary",type:"line",minzoom:4,source:"villageBoundary",layout:{},paint:{"line-color":"black","line-width":2}})}),map.on("style.load",function(){map.addSource("villageAreas",{type:"geojson",data:"/assets/data/village_areas.json"}),map.addLayer({id:"village-boundary",type:"line",minzoom:5.5,maxzoom:13.5,source:"villageAreas",layout:{},paint:{"line-color":"red","line-width":1}}),map.addLayer({id:"village-areas",type:"fill",minzoom:5.5,maxzoom:13.5,source:"villageAreas",layout:{},paint:{"fill-color":"#DF837D","fill-opacity":.5}}),map.addLayer({id:"village-areas-hover",type:"fill",minzoom:5.5,maxzoom:13.5,source:"villageAreas",layout:{},paint:{"fill-color":"#DF837D","fill-opacity":.1},filter:["==","name",""]}),map.on("mousemove",function(e){var features=map.queryRenderedFeatures(e.point,{layers:["village-areas"]});features.length?map.setFilter("village-areas-hover",["==","name",features[0].properties.name]):map.setFilter("village-areas-hover",["==","name",""])})}),map.on("style.load",function(){map.addSource("villageCentres",{type:"geojson",data:"/assets/data/dhone_village_centres.json"}),map.addLayer({id:"labels",type:"symbol",source:"villageCentres",minzoom:10,maxzoom:12.6,layout:{"text-field":"{name}","text-font":["Open Sans Semibold","Arial Unicode MS Bold"],"text-offset":[-2,-2],"text-anchor":"top","text-size":10,"text-allow-overlap":!0,"text-letter-spacing":.1},paint:{"text-halo-color":"#dddddd","text-halo-width":2,"text-halo-blur":1}})});var popup=new mapboxgl.Popup({closeOnClick:!1,closeButton:!1,anchor:"right"}).setLngLat([77.81,15.4]).setHTML("<p>Revenue Village</p>").addTo(map);document.getElementById("villageZoom").addEventListener("click",function(){popup.remove(),map.flyTo({center:[77.8271,15.389],zoom:11.5,bearing:0,speed:.3,curve:1.42})}),map.dragRotate.disable(),map.touchZoomRotate.disableRotation();for(var layerList=document.getElementById("location-menu"),inputs=layerList.getElementsByTagName("input"),i=0;i<inputs.length;i++)inputs[i].onclick=switchLayer;var marginRain={top:10,right:10,bottom:40,left:60},marginRain2={top:45,right:40,bottom:75,left:70},widthRain=1100-marginRain.left-marginRain.right,heightRain=400-marginRain.top-marginRain.bottom;heightRain2=400-marginRain2.top-marginRain2.bottom,widthRain2=1100-marginRain2.left-marginRain2.right;var minRain=0,maxRain=550,zoomed=!1,annualRainfall,labels=!1,dailyRainfall,svgRainBox=d3.select("#rainfall-mon-box").append("svg").attr("width",widthRain+marginRain.left+marginRain.right).attr("height",heightRain+marginRain.top+marginRain.bottom).attr("class","box rainfallSVG").append("g").attr("transform","translate("+marginRain.left+","+marginRain.top+")");d3.csv("/assets/data/dhone_rainfall_monthly.csv",function(error,csv){var data=[];data[0]=[],data[1]=[],data[2]=[],data[3]=[],data[4]=[],data[5]=[],data[6]=[],data[7]=[],data[8]=[],data[9]=[],data[10]=[],data[11]=[],data[0][0]="Jan",data[1][0]="Feb",data[2][0]="Mar",data[3][0]="Apr",data[4][0]="May",data[5][0]="Jun",data[6][0]="Jul",data[7][0]="Aug",data[8][0]="Sep",data[9][0]="Oct",data[10][0]="Nov",data[11][0]="Dec",data[0][1]=[],data[1][1]=[],data[2][1]=[],data[3][1]=[],data[4][1]=[],data[5][1]=[],data[6][1]=[],data[7][1]=[],data[8][1]=[],data[9][1]=[],data[10][1]=[],data[11][1]=[],csv.forEach(function(x){var v1=Math.floor(x[1]),v2=Math.floor(x[2]),v3=Math.floor(x[3]),v4=Math.floor(x[4]);v5=Math.floor(x[5]),v6=Math.floor(x[6]),v7=Math.floor(x[7]),v8=Math.floor(x[8]),v9=Math.floor(x[9]),v10=Math.floor(x[10]),v11=Math.floor(x[11]),v12=Math.floor(x[12]),data[0][1].push(v1),data[1][1].push(v2),data[2][1].push(v3),data[3][1].push(v4),data[4][1].push(v5),data[5][1].push(v6),data[6][1].push(v7),data[7][1].push(v8),data[8][1].push(v9),data[9][1].push(v10),data[10][1].push(v11),data[11][1].push(v12)});var chart=d3.box().whiskers(iqr(1.5)).height(heightRain).domain([minRain,maxRain]).showLabels(labels),xRainBox=d3.scale.ordinal().domain(data.map(function(d){return d[0]})).rangeRoundBands([0,widthRain],.6,.3),yRainBox=d3.scale.linear().domain([minRain,maxRain]).range([heightRain,0]),xAxisRain=d3.svg.axis().scale(xRainBox).orient("bottom").outerTickSize(0),yAxisRain=d3.svg.axis().innerTickSize(-widthRain).outerTickSize(0).scale(yRainBox).orient("left");svgRainBox.append("g").attr("class","y axis").call(yAxisRain).append("text").attr("transform","rotate(-90)").attr("y",0-marginRain.left+20).attr("x",0-heightRain/2).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Rainfall (mm)"),svgRainBox.append("g").attr("class","x axis").attr("transform","translate(0,"+heightRain+")").call(xAxisRain).append("text").attr("x",widthRain/2).attr("y",40).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Month"),svgRainBox.selectAll(".box").data(data).enter().append("g").attr("class","b").attr("transform",function(d){return"translate("+xRainBox(d[0])+",0)"}).call(chart.width(xRainBox.rangeBand())),d3.selectAll(".b").on("mouseover",function(d){d3.select(this).selectAll(".box").style("fill","#55d0f1"),d3.select(this).selectAll(".outlier").style("fill","#55d0f1"),Math.round(d[1].quartiles[1])>0&&d3.select(this).append("text").attr("class","stats").attr("x",37).attr("y",yRainBox(d[1].quartiles[1])).text(function(){return Math.round(d[1].quartiles[1])+" mm"}),Math.round(yRainBox.invert(d3.select(this).selectAll(".whisker")[0][0].getAttribute("y2")))>0&&d3.select(this).append("text").attr("class","stats").attr("x",d3.select(this).selectAll(".whisker")[0][0].getAttribute("x2")).attr("y",d3.select(this).selectAll(".whisker")[0][0].getAttribute("y2")).text(Math.round(yRainBox.invert(d3.select(this).selectAll(".whisker")[0][0].getAttribute("y2")))+" mm"),d3.select(this).append("text").attr("class","stats").attr("x",d3.select(this).selectAll(".whisker")[0][1].getAttribute("x2")).attr("y",d3.select(this).selectAll(".whisker")[0][1].getAttribute("y2")).text(Math.round(yRainBox.invert(d3.select(this).selectAll(".whisker")[0][1].getAttribute("y2")))+" mm");var outliers=d3.selectAll(d3.select(this).selectAll(".outlier")),outliers=outliers[0][0].reverse();if(outliers.length>0)var position=parseInt(outliers[0].getAttribute("cy"))-50;for(var i=0;i<outliers.length;i++)(position-parseInt(outliers[i].getAttribute("cy"))<-5||1==outliers.length)&&d3.select(this).append("text").attr("class","stats").attr("x",Math.round(outliers[i].getAttribute("cx"))+10).attr("y",Math.round(outliers[i].getAttribute("cy"))).text(Math.round(yRainBox.invert(outliers[i].getAttribute("cy")))+" mm"),position=parseInt(outliers[i].getAttribute("cy"))}).on("mouseout",function(d){d3.select(this).selectAll(".box").style("fill","#4DBAD9"),d3.select(this).selectAll(".outlier").style("fill","none"),d3.selectAll(".stats").remove()});var zoomButton=svgRainBox.append("rect").attr("class","zoom").attr("width",80).attr("height",30).attr("x",10).attr("y",0).attr("rx","5px").attr("ry","5px").style("stroke","black").style("stroke-width",1.1).style("filter","url(#drop-shadow)"),zoomText=svgRainBox.append("text").attr("x",50).attr("y",22).attr("text-anchor","middle").attr("pointer-events","none").style("font-size","16px").text("Zoom In");d3.select(".zoom").on("mouseover",function(){zoomButton.style("stroke-width",2).style("fill","#d3d3d3"),zoomText.style("font-weight","bold")}).on("mouseout",function(){zoomButton.style("stroke-width",1.1).style("fill","#DDDDDD"),zoomText.style("font-weight","normal")}).on("click",function(){zoomed?(zoomed=!1,yRainBox.domain([0,650]),yAxisRain.scale(yRainBox),svgRainBox.select("g.y.axis").transition().duration(1e3).call(yAxisRain),chart.domain([0,650]),svgRainBox.selectAll(".b").call(chart.width(xRainBox.rangeBand())),zoomText.text("Zoom In")):(zoomed=!0,yRainBox.domain([0,305]),yAxisRain.scale(yRainBox),svgRainBox.select("g.y.axis").transition().duration(1e3).call(yAxisRain),chart.domain([0,305]),svgRainBox.selectAll(".b").call(chart.width(xRainBox.rangeBand())),zoomText.text("Zoom Out"))})});var defs=svgRainBox.append("defs"),filter=defs.append("filter").attr("id","drop-shadow").attr("height","130%");filter.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",1).attr("result","blur"),filter.append("feOffset").attr("in","blur").attr("dx",1).attr("dy",1).attr("result","offsetBlur");var feMerge=filter.append("feMerge");feMerge.append("feMergeNode").attr("in","offsetBlur"),feMerge.append("feMergeNode").attr("in","SourceGraphic");var svgRainAnn=d3.select("#rainfall-ann").append("svg").attr("width",widthRain+marginRain.left+marginRain.right).attr("height",heightRain+marginRain.top+marginRain.bottom).attr("class","box rainfallSVG").append("g").attr("transform","translate("+marginRain.left+","+marginRain.top+")");d3.csv("/assets/data/dhone_rainfall_annual.csv",function(error,csv){annualRainfall=csv;var xRainAnn=d3.scale.ordinal().domain(d3.range(csv.length)).rangeRoundBands([0,widthRain],.2,.2),yRainAnn=d3.scale.linear().domain([0,1400]).range([heightRain,0]),xAxisAnn=d3.svg.axis().scale(xRainAnn).orient("bottom").outerTickSize(0).tickFormat(function(d){return annualRainfall[d].water_year}),yAxisAnn=d3.svg.axis().innerTickSize(-widthRain).outerTickSize(0).scale(yRainAnn).orient("left").ticks(15);svgRainAnn.append("g").attr("class","y axis").call(yAxisAnn).append("text").attr("transform","rotate(-90)").attr("y",0-marginRain.left+20).attr("x",0-heightRain/2).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Rainfall (mm)"),svgRainAnn.append("g").attr("class","x axis").attr("transform","translate(0,"+heightRain+")").call(xAxisAnn).append("text").attr("x",widthRain/2).attr("y",35).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Year (June - May)"),svgRainAnn.selectAll("rect").data(annualRainfall).enter().append("rect").attr("x",function(d,i){return xRainAnn(i)}).attr("y",function(d){return yRainAnn(d.total_rainfall)}).attr("width",xRainAnn.rangeBand()).attr("height",function(d){return heightRain-yRainAnn(d.total_rainfall)}).style("fill","#4DBAD9").on("mouseover",function(d){var barData=d;svgRainAnn.append("text").attr("x",parseInt(this.getAttribute("x"))+15).attr("y",parseInt(this.getAttribute("y"))+15).attr("class","tooltip").text(function(){return Math.round(barData.total_rainfall)}).style("text-anchor","middle").style("font-size","12px").style("font-weight","bold"),d3.select(this).style("fill","#55d0f1")}).on("mouseout",function(d){svgRainAnn.selectAll(".tooltip").remove(),d3.select(this).style("fill","#4DBAD9")}),svgRainAnn.append("line").attr("class","avLine").attr("x1",0).attr("x2",widthRain).attr("y1",yRainAnn(613)).attr("y2",yRainAnn(613)),d3.selectAll(".avLine").on("mouseover",function(){d3.select(this).style("stroke-width",5).style("opacity",1),svgRainAnn.append("text").attr("id","avRainfall").attr("x",widthRain/10).attr("y",this.getAttribute("y1")-5).text("Average: 613 mm")}).on("mouseout",function(){d3.select(this).style("stroke-width",3).style("opacity",.8),d3.select("#avRainfall").remove()})});var svgRD=d3.select("#rainfall-daily").append("svg").attr("width",widthRain2+marginRain2.left+marginRain2.right).attr("height",heightRain2+marginRain2.top+marginRain2.bottom).attr("class","box rainfallSVG"),svgRainDaily=svgRD.append("g").attr("transform","translate("+marginRain2.left+","+marginRain2.top+")");d3.csv("/assets/data/dhone_rainfall_daily.csv",function(error,csv){for(var rainTotals=d3.nest().key(function(d){return d.water_year}).key(function(d){return d.Month}).rollup(function(csv){var count=d3.sum(csv,function(d){return Math.round(d.Rainfall)});return count}).entries(csv),i=0;i<rainTotals.length;i++){for(var month=rainTotals[i].values,total=0,j=0;j<month.length;j++)total+=month[j].values;rainTotals[i].annualTotal=Math.round(total)}rainTotals=rainTotals.reverse();var months=["June","July","August","September","October","November","December","January","February","March","April","May"],legendAmounts=[10,25,100,250],xDayScale=d3.scale.linear().domain([1,366]).range([5,950]),xAxisDaily=d3.svg.axis().scale(xDayScale).orient("bottom").tickValues([1,50,100,150,200,250,300,350]),yDailyScale=d3.scale.ordinal().domain(["97/98","98/99","99/00","00/01","01/02","02/03","03/04","04/05","05/06","06/07","07/08"]).rangeRoundBands([heightRain2,0],0,.2),yAxisDaily=d3.svg.axis().innerTickSize(-950).outerTickSize(0).scale(yDailyScale).orient("left"),radiusScale=d3.scale.linear().domain([0,15.70986951]).range([0,15]),xMonthScale=d3.scale.ordinal().domain(months).rangeRoundBands([5,950]),xAxisMonth=d3.svg.axis().scale(xMonthScale).orient("top").outerTickSize(0).innerTickSize(5),zoomScale=d3.scale.ordinal().domain(months).range([[1,30],[31,61],[62,92],[93,122],[123,153],[154,183],[184,214],[215,245],[246,274],[274,305],[305,335],[335,366]]),xScaleDayMonth=d3.scale.linear().domain([0,32]).range([0,950]),xAxisDayMonth=d3.svg.axis().scale(xScaleDayMonth).orient("bottom").outerTickSize(0).tickValues([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]),totals=svgRD.append("g").attr("transform","translate(1030,35)");totals.append("text").attr("x","5px").attr("y","12px").style("font-weight","bold").style("font-size","16px").style("text-decoration","underline").text("Total");var rTotals=totals.selectAll("g").data(rainTotals).enter().append("g").append("text").attr("y",function(d,i){return 34+24*i+"px"}).attr("x","5px").text(function(d){return d.annualTotal+" mm"}).style("font-size","12px"),legendDaily=svgRainDaily.append("svg").attr("id","legendDaily").attr("width",300).attr("height",40).attr("x",0).attr("y",heightRain2+33).append("g");legendDaily.append("rect").attr("width",298).attr("height",38).attr("x",1).attr("y",1).style("fill","#f0f0f0"),legendDaily.selectAll("circle").data(legendAmounts).enter().append("circle").attr("cy",20).attr("cx",function(d,i){return 5+50*i+5*radiusScale(Math.sqrt(d))}).attr("r",function(d){return radiusScale(Math.sqrt(d))}).style("opacity",.5).style("stroke","none"),legendDaily.selectAll("text").data(legendAmounts).enter().append("text").attr("x",function(d,i){return 12+50*i+5*radiusScale(Math.sqrt(d))+radiusScale(Math.sqrt(d))}).attr("y",25).text(function(d){return d+" mm"}),svgRainDaily.append("g").attr("class","x axis months").attr("transform","translate(0,-10)").call(xAxisMonth),svgRainDaily.append("g").attr("class","x axis days").attr("transform","translate(0,"+(heightRain2+7)+")").call(xAxisDaily).append("text").attr("x",500).attr("y",35).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Day"),svgRainDaily.selectAll("circle").data(csv).enter().append("circle").attr("class","rainfallCircles").attr("cx",function(d){return xDayScale(d.year_day)}).attr("cy",function(d){return yDailyScale(d.water_year)+12}).attr("r",function(d){return radiusScale(Math.sqrt(d.Rainfall))}).style("opacity",.5).style("stroke","none").on("mouseover",function(d){var day=d;d3.select(this).style("fill","#FF8B3F").style("stroke","c3c3c3"),svgRainDaily.append("rect").attr("class","svgTooltip").attr("width",122).attr("height",48).attr("x",parseInt(this.getAttribute("cx"))-78).attr("y",parseInt(this.getAttribute("cy"))-parseInt(this.getAttribute("r"))-50),svgRainDaily.append("text").attr("class","svgTooltip").attr("x",parseInt(this.getAttribute("cx"))-73).attr("y",parseInt(this.getAttribute("cy"))-parseInt(this.getAttribute("r"))-30).text(function(d){return day.date}),svgRainDaily.append("text").attr("class","svgTooltip").attr("x",parseInt(this.getAttribute("cx"))-73).attr("y",parseInt(this.getAttribute("cy"))-parseInt(this.getAttribute("r"))-10).text(function(d){return"Rainfall: "+day.Rainfall+" mm"})}).on("mouseout",function(d){d3.select(this).style("fill","#4DBAD9").style("stroke","none"),svgRainDaily.selectAll(".svgTooltip").remove()}),svgRainDaily.append("rect").attr("width",70).attr("height",280).attr("x",-70).attr("y",-5).style("stroke","none").style("fill","white"),svgRainDaily.append("rect").attr("width",78).attr("height",280).attr("x",950).attr("y",-5).style("stroke","none").style("fill","white"),svgRainDaily.append("g").attr("class","y axis").call(yAxisDaily).append("text").attr("transform","rotate(-90)").attr("y",0-marginRain2.left+20).attr("x",0-heightRain2/2).style("text-anchor","middle").style("font-size","16px").style("font-weight","bold").style("letter-spacing",1.2).text("Year (June - May)");var selectedMonth;d3.select("#rainfall-daily").selectAll(".x .tick text").on("mouseover",function(d){var month=d;d3.select(this).style("text-decoration","underline"),svgRainDaily.selectAll(".rainfallCircles").style("fill",function(d){return d.Month==month?"#FF8B3F":"#4DBAD9"})}).on("mouseout",function(d){d3.select(this).style("text-decoration","none"),svgRainDaily.selectAll(".rainfallCircles").style("fill","#4DBAD9")}).on("click",function(d){var month=d;svgRainDaily.selectAll(".rainfallCircles").style("fill","#4DBAD9"),
month==selectedMonth?(d3.select("#rainfall-daily").selectAll(".months text").transition().duration(1e3).attr("y",-8).style("font-size","14px").style("font-weight","normal").style("fill","black"),xDayScale.domain([1,366]),selectedMonth=null,svgRainDaily.selectAll(".rainfallCircles").transition().duration(1500).attr("cx",function(d){return xDayScale(d.year_day)}).attr("r",function(d){return radiusScale(Math.sqrt(d.Rainfall))}),svgRainDaily.select(".x.axis.days").transition().duration(1500).call(xAxisDaily),rTotals.transition().duration(1e3).text(function(d){return d.annualTotal+" mm"})):(d3.select("#rainfall-daily").selectAll(".months text").transition().duration(1e3).attr("y",function(d){return d!=month?-5:-15}).style("font-size",function(d){return d!=month?"10px":"20px"}).style("font-weight",function(d){return d!=month?"normal":"bold"}).style("fill",function(d){return d!=month?"#adadad":"black"}),svgRainDaily.selectAll(".rainfallCircles").attr("r",function(d){return radiusScale(Math.sqrt(d.Rainfall))}),xDayScale.domain(zoomScale(month)),selectedMonth=month,svgRainDaily.selectAll(".rainfallCircles").transition().duration(1500).attr("cx",function(d){return d.Month==month?xScaleDayMonth(d.Day):xDayScale(d.year_day)}),svgRainDaily.selectAll(".rainfallCircles").transition().delay(1500).duration(0).attr("r",function(d){return d.Month==month?radiusScale(Math.sqrt(d.Rainfall)):0}),svgRainDaily.select(".x.axis.days").transition().duration(1500).call(xAxisDayMonth),rTotals.transition().duration(1e3).text(function(d){for(var i=0;i<d.values.length;i++)if(d.values[i].key==month)return d.values[i].values+" mm"}))}),svgRainDaily.append("text").attr("x",widthRain2/2+220).attr("y",heightRain2+60).style("font-size","20px").style("font-weight","bold").style("fill","#737373").text("Click on months to zoom in/out")}),d3.select("#rainfall-selection-left").attr("class","selected rainfall-selection").style("background-color","white").style("bottom","-1px"),d3.selectAll("#rainfall-charts > div").style("display","none").style("opacity",0),d3.select("#rainfall-ann").attr("class","selected").style("display","block").style("opacity",1),d3.selectAll(".rainfall-selection").on("mouseover",function(){d3.select(this).style("font-weight","bold")}).on("mouseout",function(){d3.select(this).style("font-weight","normal")}).on("click",function(){d3.select("#rainfall-selection-right").style("border-right","0px"),d3.selectAll(".rainfall-selection").style("background-color","#e8e8e8").style("bottom","0px"),d3.select(this).style("background-color","white").style("bottom","-1px"),"rainfall-selection-right"==this.getAttribute("id")&&d3.select(this).style("border-right","1px solid #a8a8a8"),"selected rainfall-selection"!=this.getAttribute("class")&&(d3.selectAll(".rainfall-selection").attr("class","rainfall-selection"),d3.select(this).attr("class","selected rainfall-selection"),d3.selectAll("#rainfall-charts .selected").classed("selected",!1).style("opacity",0),d3.selectAll("#rainfall-charts > div").style("display","none"),"Monthly Rainfall"==this.textContent?d3.select("#rainfall-mon-box").attr("class","selected").style("display","block").transition().duration(800).style("opacity",1):"Annual Rainfall"==this.textContent?d3.select("#rainfall-ann").attr("class","selected").style("display","block").transition().duration(800).style("opacity",1):"Daily Rainfall"==this.textContent&&d3.select("#rainfall-daily").attr("class","selected").style("display","block").transition().duration(800).style("opacity",1))});var startYear=1980,step=startYear,sliderStatus="paused",scrollTrig=!0,yearDuration=1e3,buttonText="Well Depth",interval,wellData,wellCircles,lineData,wellTrig,slider=d3.slider().axis(d3.svg.axis().ticks(33).tickSize(6).tickFormat(d3.format(".0d"))).min(startYear).max(2012).value(startYear).step(1);d3.select("#slider").call(slider);var margin_map={top:5,right:10,bottom:5,left:10},margin_bar={top:10,right:5,bottom:22,left:40},margin_chart={top:15,right:0,bottom:18,left:50},margin_line={top:15,right:20,bottom:18,left:65},w=520-margin_map.left-margin_map.right,w2=280-margin_bar.left-margin_bar.right,w3=615-margin_line.left-margin_line.right,w4=310-margin_bar.left-margin_bar.right,w5=300-margin_bar.left-margin_bar.right,h=550-margin_map.top-margin_map.bottom,h2=180-margin_bar.top-margin_bar.bottom,h3=275-margin_chart.top-margin_chart.bottom,h4=270-margin_chart.top-margin_chart.bottom,projection=d3.geo.transverseMercator().rotate([-77.8095,-15.391,0]).translate([w/2,h/2]).scale(33e4),path=d3.geo.path().projection(projection),colorDepth=d3.scale.threshold().domain([10,50,100,300]).range(["#c4d4e1","#6baed6","#2171b5","#08306b"]),colorType=d3.scale.ordinal().domain(["Open Well","Agricultural Borewell","Domestic Borewell"]).range(["#C4ED68","#59A80F","#ba831f"]),colorStatus=d3.scale.ordinal().domain(["Defunct","Fails every summer","Fails during droughts","Has never failed"]).range(["#784860","#C07860","#F8CA8C","#FFF4C2"]),landuseScale=d3.scale.ordinal().domain(["Single Crop","Double Crop","Plantation","Fallow","Scrub","Rocky Ground","Settlements"]).range(["#9bca6c","#5fb933","#b68f30","#ffff8c","#f8d496","#828482","#bb312f"]),dem_colors=["#227516","#648744","#9bc133","#cdcb32","#fed976","#ffeda0","#ffffcc","#d7cebf","#b6b098","#986b41","#561f10"],dem_breaks=["0%","5%","9%","15%","24%","33%","43%","52%","64%","76%","100%"],dem_scale=d3.scale.linear().domain([390,620]).range([0,135]),svg_map=d3.select("#well-viz-map").append("svg").attr("width",w+margin_map.left+margin_map.right).attr("height",h+margin_map.top+margin_map.bottom).append("g").attr("transform","translate("+margin_map.left+","+margin_map.top+")");svg_map.append("rect").attr("class","mapBorder").attr("x",0).attr("y",0).attr("height",h).attr("width",w),svg_map.append("svg:image").attr("xlink:href","/assets/data/background.jpg").attr("x",0).attr("y",0).attr("width",500).attr("height",540);var legend=d3.select("#legend").append("svg").attr("id","legendSVG").attr("width",165).attr("height",200).append("g").attr("id","legendBox");dem_legend=legend.append("g").attr("width",135).attr("height",15).attr("transform","translate(15,45)");for(var gradientDEM=dem_legend.append("defs").append("linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),i=0;i<dem_colors.length;i++)gradientDEM.append("stop").attr("offset",dem_breaks[i]).attr("stop-color",dem_colors[i]).attr("stop-opacity",.6);var gradientBar=dem_legend.append("rect").attr("y",0).attr("width",135).attr("height",15).attr("fill","url(#gradient)").style("stroke","black").style("stroke-width",1),dem_Axis=d3.svg.axis().scale(dem_scale).orient("top").tickValues([390,500,620]);dem_legend.append("g").attr("class","x axis demAxis").call(dem_Axis).append("text").attr("x",0).attr("y",-25).text("Elevation (metres)").style("font-size","12px");var boundaryLegend=legend.append("g").attr("id","boundaryLegend").attr("transform","translate(15,80)");boundaryLegend.append("line").attr("x1",0).attr("y1",0).attr("x2",15).attr("y2",0).style("stroke","black").style("stroke-width",1.5).style("shape-rendering","auto"),boundaryLegend.append("text").attr("x",32).attr("y",5).text("Study Area").style("font-size","12px");var drainageLegend=legend.append("g").attr("id","boundaryLegend").attr("transform","translate(15,100)");drainageLegend.append("line").attr("x1",0).attr("y1",0).attr("x2",15).attr("y2",0).style("stroke","#1f78b4").style("stroke-width",1.5).style("shape-rendering","auto"),drainageLegend.append("text").attr("x",32).attr("y",5).text("Drainage").style("font-size","12px");var legendLanduse=d3.select(".legendLanduse").attr("id","landuse1").append("svg").attr("class","legendLanduseSVG").attr("width",165).attr("height",25);legendLanduse.append("text").text("Show Landuse").attr("x",35).attr("y",18).style("font-weight","bold").style("text-decoration","underline");var svg_type=d3.select("#well-viz-chart2").append("svg").attr("width",w2+margin_bar.left+margin_bar.right).attr("height",h2+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_bar.left+","+margin_bar.top+")"),svg_depth=d3.select("#well-viz-chart1").append("svg").attr("width",w2+margin_bar.left+margin_bar.right).attr("height",h2+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_bar.left+","+margin_bar.top+")"),svg_status=d3.select("#well-viz-chart3").append("svg").attr("width",w2+margin_bar.left+margin_bar.right).attr("height",h2+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_bar.left+","+margin_bar.top+")"),svg_line=d3.select("#well-viz-chart4").append("svg").attr("width",w4+margin_chart.left+margin_chart.right).attr("height",h3+margin_chart.top+margin_chart.bottom).append("g").attr("transform","translate("+margin_chart.left+","+margin_chart.top+")"),svg_avDep=d3.select("#well-viz-chart5").append("svg").attr("width",w4+margin_chart.left+margin_bar.right).attr("height",h3+margin_chart.top+margin_chart.bottom).append("g").attr("transform","translate("+margin_chart.left+","+margin_chart.top+")"),xType=d3.scale.ordinal().rangeRoundBands([0,w2],.05),yType=d3.scale.linear().range([h2,0]),xDepth=d3.scale.ordinal().rangeRoundBands([0,w2],.05),yDepth=d3.scale.linear().range([h2,0]),xStatus=d3.scale.ordinal().rangeRoundBands([0,w2],.05),yStatus=d3.scale.linear().range([h2,0]),xline=d3.scale.linear().range([0,w4]).domain([1970,2013]),yline=d3.scale.linear().range([h3,0]).domain([0,600]),xAvDep=d3.scale.linear().range([0,w4]).domain([1970,2013]),yAvDep=d3.scale.linear().range([h3,0]).domain([0,50]);$(window).on("load",function(){$(window).on("scroll",function(){$("#well-viz").offset().top-($(window).scrollTop()+$(window).height())<-($(window).height()/2)&&scrollTrig&&slider.value()<2012&&(d3.select(".playPause span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatus="playing",d3.select("#well-viz .glyphicon").attr("title","Pause Animation"),animate(),scrollTrig=!1)})}),createWellVis();var startYearRWH=1998,rwhData,capacityData,buttonTextRWH="RWH Type",cubedMetres="m³",stepRWH=startYearRWH,sliderStatusRWH="paused",scrollTrigRWH=!0,intervalRWH,sliderRWH=d3.slider().axis(d3.svg.axis().ticks(17).tickSize(6).tickFormat(d3.format(".0d"))).min(1998).max(2012).value(startYearRWH).step(1);d3.select("#slider-rwh").call(sliderRWH),commas=d3.format(",");var svg_map_rwh=d3.select("#rwh-viz-map").append("svg").attr("width",w+margin_map.left+margin_map.right).attr("height",h+margin_map.top+margin_map.bottom).append("g").attr("transform","translate("+margin_map.left+","+margin_map.top+")");svg_map_rwh.append("rect").attr("class","mapBorder").attr("x",0).attr("y",0).attr("height",h).attr("width",w),svg_map_rwh.append("svg:image").attr("xlink:href","/assets/data/background.jpg").attr("x",0).attr("y",0).attr("width",500).attr("height",540);var legendRWH=d3.select("#legendRWH").append("svg").attr("id","legendSVG_RWH").attr("width",150).attr("height",200).append("g").attr("id","legendBoxRWH");dem_legendRWH=legendRWH.append("g").attr("width",135).attr("height",15).attr("transform","translate(15,45)");for(var gradientDEM_RWH=dem_legendRWH.append("defs").append("linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),i=0;i<dem_colors.length;i++)gradientDEM_RWH.append("stop").attr("offset",dem_breaks[i]).attr("stop-color",dem_colors[i]).attr("stop-opacity",.6);var gradientBarRWH=dem_legendRWH.append("rect").attr("y",0).attr("width",135).attr("height",15).attr("fill","url(#gradient)").style("stroke","black").style("stroke-width",1);dem_legendRWH.append("g").attr("class","x axis demAxis").call(dem_Axis).append("text").attr("x",0).attr("y",-25).text("Elevation (metres)").style("font-size","12px");var boundaryLegendRWH=legendRWH.append("g").attr("id","boundaryLegend").attr("transform","translate(15,80)");boundaryLegendRWH.append("line").attr("x1",0).attr("y1",0).attr("x2",15).attr("y2",0).style("stroke","black").style("stroke-width",1.5).style("shape-rendering","auto"),boundaryLegendRWH.append("text").attr("x",32).attr("y",5).text("Study Area").style("font-size","12px");var drainageLegendRWH=legendRWH.append("g").attr("id","DrainageLegend").attr("transform","translate(15,100)");drainageLegendRWH.append("line").attr("x1",0).attr("y1",0).attr("x2",15).attr("y2",0).style("stroke","#1f78b4").style("stroke-width",1.5).style("shape-rendering","auto"),drainageLegendRWH.append("text").attr("x",32).attr("y",5).text("Drainage").style("font-size","12px");var rwhTypeScale=d3.scale.ordinal().domain(["Check Dam","Infiltration Pond","Bund"]).range(["#BDBBC4","#5D9CA5","#7a591f"]),rwhStatusScale=d3.scale.ordinal().domain(["Destroyed","Damaged","Good Condition"]).range(["#D7191C","#FDAE61","#2C7BB6"]),rwhSizeScale=d3.scale.linear().domain([100,1e3,1e4,4e4]).range([56.23,167.49,1268.53,5e3]),rwhTypeScaleLine=d3.scale.ordinal().domain(["bunds","check_dams","infiltration_ponds"]).range(["#7a591f","#BDBBC4","#5D9CA5"]),rwh_type=d3.select("#rwh-viz-chart1").append("svg").attr("width",w5+margin_bar.left+margin_bar.right).attr("height",h4+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_bar.left+","+margin_bar.top+")"),rwh_status=d3.select("#rwh-viz-chart2").append("svg").attr("width",w5+margin_bar.left+margin_bar.right).attr("height",h4+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_bar.left+","+margin_bar.top+")"),rwh_capacity=d3.select("#rwh-viz-chart3").append("svg").attr("width",w3+margin_line.left+margin_line.right).attr("height",h4+margin_bar.top+margin_bar.bottom).append("g").attr("transform","translate("+margin_line.left+","+margin_bar.top+")"),xTypeRWH=d3.scale.ordinal().rangeRoundBands([0,w5],.05),yTypeRWH=d3.scale.linear().range([h4,0]),xStatusRWH=d3.scale.ordinal().rangeRoundBands([0,w5],.05),yStatusRWH=d3.scale.linear().range([h4,0]),xlineRWH=d3.scale.linear().range([0,w3]).domain([1998,2012]),ylineRWH=d3.scale.linear().range([h4,0]).domain([0,12e4]);rwhNames=["Bunds","Check Dams","Infiltration Ponds"],$(window).on("load",function(){$(window).on("scroll",function(){$("#rwh-viz").offset().top-($(window).scrollTop()+$(window).height())<-($(window).height()/2)&&scrollTrigRWH&&sliderRWH.value()<2012&&(d3.select(".playPauseRWH span").classed("glyphicon",!1).attr("class","glyphicon glyphicon-pause"),sliderStatusRWH="playing",d3.select("#rwh-viz .glyphicon").attr("title","Pause Animation"),animateRWH(),scrollTrigRWH=!1)})}),drawFeaturesRWH(),drawRWH(),updateLegendRWH(rwhTypeScale),activateButtonsRWH();