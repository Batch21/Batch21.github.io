<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Water Scacity Mapping</title>
		<link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css">
		<script type="text/javascript" src="/assets/js/d3.js"></script>
		<script type="text/javascript" src="/assets/js/d3.slider.js"></script>
		<script type="text/javascript" src="/assets/js/jquery-3.0.0.js"></script>
		<style type="text/css">
		
			circle{
				-moz-transition: all 0.3s;
				-o-transition: all 0.3s;
				-webkit-transition: all 0.3s;
				transition: all 0.5s;
			}
			
			circle:hover {
				fill: blue;
			}

            #col{
            	width:100%;
            }

			#slider{
				width: auto;
				margin-bottom: 40px;
				margin-left: auto;
				margin-right: auto;
			}

			.well-viz-com{
				display: inline-block;
			}

			.mapBorder{
				stroke: black;
				fill: none;
				stroke-width: 1;
			}

			.charts{
				display: float;
			}

			.axis path,
			.axis line {
				fill: none;
				stroke: black;
				shape-margin: crispEdges;
			}

			.axis text {
				font-family: sans-serif;
				font-size: 10px;
			}

	
		</style>
		<link rel="stylesheet" type="text/css" href="/styles.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/d3.slider.css">
	</head>
	<body>
      <div class="container">
       <div class="content">
      	<header>
        <h3>Visualising Water Scarity in Andhra Pradesh </h3>
        </header>
        
    	 <div id="well-viz">
    	 	<h2>Year: <span id="slidertext">1970</span></h2>
    	    <div id="slider"></div>
    	    <div id="well-viz-map" class="well-viz-com"></div>
    	 	<div class="well-viz-com" >
    	 		<div id="well-viz-chart1" class="charts"></div>
    	 		<div id="well-viz-chart2" class="charts"></div>
    	 	</div>
    	 </div>
    	 <p> The above map shows....</p>
       </div>
		<script type="text/javascript">

			$(function(){

				var $title = $('h3');
				var $para = $('p');
				var $window = $("window");
			
				$title.on('mouseover', function(e){
					console.log(e.pageX);
					$title.css({
						'color': 'red'
					});
				})	

				$title.on("mouseout", function(){
					$title.css({
						'color': 'black'
					});
				})

				$para.on("mouseover", function(e){
					console.log($(window).scrollTop());
				});
			
			});

			var slider = d3.slider().axis(true).min(1970).max(2012).value(1970).step(1);

			d3.select('#slider').call(slider);

			var margin_map = {top: 20, right: 10, bottom: 20, left: 10};
			var margin_bar = {top: 20, right: 20, bottom: 20, left: 40};

			//Width and height
			var w = 400 - margin_map.left - margin_map.right,
				w2 = 280 - margin_bar.left - margin_bar.right,
			    h = 740 - margin_map.top - margin_map.bottom,
			    h2 = 370 - margin_bar.left - margin_bar.right;

			//Define map projection
			var projection = d3.geo.transverseMercator()
			      				   .rotate([-77.82519, -15.39099, 0])
			      				   .translate([w/2, h/2])
			      				   .scale(420000);


			//Define path generator
			var path = d3.geo.path()
							 .projection(projection);

			var color = d3.scale.quantize()
								.range(["rgb(248,202,140)", "rgb(240,168,72)","rgb(192,120,96)",
									"rgb(168,96,96)", "rgb(120,72,96)"]);
			
			//Create SVG element
			var svg_map = d3.select("#well-viz-map").append("svg")
				.attr("width", w + margin_map.left + margin_map.right)
    			.attr("height", h + margin_map.top + margin_map.bottom)
  				.append("g")
    			.attr("transform", "translate(" + margin_map.left + "," + margin_map.top + ")");

    		svg_map.append("rect")
    			.attr("class", "mapBorder")
    			.attr("x", 0)
    			.attr("y", 0)
    			.attr("height", h)
    			.attr("width", w)


			d3.json("/assets/data/dhone_area.json", function(json) {
				
				svg_map.selectAll("path")
				   .data(json.features)
				   .enter()
				   .append("path")
				   .attr("d", path)
				   .attr("fill", "none")
				   .attr("stroke", "black");

				 });

            

            var svg_chart1 = d3.select("#well-viz-chart1").append("svg")
						.attr("width", w2 + margin_bar.left + margin_bar.right)
    					.attr("height", h2 + margin_bar.top + margin_bar.bottom)
  						.append("g")
    					.attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");

			var svg_chart2 = d3.select("#well-viz-chart2").append("svg")
						.attr("width", w2 + margin_bar.left + margin_bar.right)
    					.attr("height", h2 + margin_bar.top + margin_bar.bottom)
  						.append("g")
    					.attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");

            xType = d3.scale.ordinal()
            	.rangeRoundBands([0, w2], 0.05);
		 	yType = d3.scale.linear()
		 		.range([h2, 0]);

		 	xDepth = d3.scale.ordinal()
            	.rangeRoundBands([0, w2], 0.05);
		 	yDepth = d3.scale.linear()
		 		.range([h2, 0]);

		 	
				   
			d3.csv("/assets/data/dhone_wells.csv", function(data) {

			    function countWells(data, attr, year){
					
					var nested = d3.nest()
                    	.key(function(d) {
                        	return d[attr];
                        	})
                    	.rollup(function(leaves) {
                        	var count = d3.sum(leaves, function(d) {
                        		if(d['year'] <= year){;
                            		return d['count'];
                            	}		
                        });
                        return {
                        	'count': count
                        };
                    })
                    .entries(data);

                    return nested;
                }
                

				var wellTypes = countWells(data, "type", 2012);
				xType.domain(d3.range(wellTypes.length))
				yType.domain([0, d3.max(wellTypes,
				 function(d) { return d.values.count; })])

				svg_chart1.append("g")
				.attr("class", "axis")
		 		.call(d3.svg.axis()
		 		.scale(yType)
		 		.orient("left"));

		 		svg_chart1.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0, " + h2 + ")")
		 		.call(d3.svg.axis()
		 		.scale(xType)
		 		.orient("bottom"));

                wellTypes = countWells(data, "type", 1970);
				
				var chart1 = svg_chart1.selectAll("rect")
			   		.data(wellTypes)		
			   		.enter()
			   		.append("rect")
			   		.attr("x", function(d, i) {
			   			return xType(i);
			   		})
			   		.attr("y", function(d) {
			   			return yType(d.values.count);
			   		})
			   		.attr("width", xType.rangeBand())
			   		.attr("height", function(d) {
			   			return h2 - yType(d.values.count);
			   		});


			   	var wellDepths = countWells(data, "depth_bin", 2012);
				xDepth.domain(d3.range(wellDepths.length))
				yDepth.domain([0, d3.max(wellDepths,
					function(d) { return d.values.count; })])

				svg_chart2.append("g")
				.attr("class", "axis")
		 		.call(d3.svg.axis()
		 		.scale(yDepth)
		 		.orient("left"));

		 		svg_chart2.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0, " + h2 + ")")
		 		.call(d3.svg.axis()
		 		.scale(xDepth)
		 		.orient("bottom"));

				wellDepths = countWells(data, "depth_bin", 1970);
				
				var chart2 = svg_chart2.selectAll("rect")
			   		.data(wellDepths)		
			   		.enter()
			   		.append("rect")
			   		.attr("x", function(d, i) {
			   			return xDepth(i);
			   		})
			   		.attr("y", function(d) {
			   			return yDepth(d.values.count);
			   		})
			   		.attr("width", xDepth.rangeBand())
			   		.attr("height", function(d) {
			   			return h2 - yDepth(d.values.count);
			   		});




				color.domain([d3.min(data, function(d) { return d.depth; }), 
					d3.max(data, function(d) { return d.depth; })
				]);
						
				var wells = svg_map.selectAll("circle")
				   .data(data)
				   .enter()
				   .append("circle")
				   .attr("cx", function(d) {
						return projection([d.lon, d.lat])[0];
				    })
					.attr("cy", function(d) {
						return projection([d.lon, d.lat])[1];
					})
					.attr("r", function(d){
						if(d.year <= 1970){
							return 3;
						}else{
							return 0;
						}
					})
					.style("fill", function(d){
					   	var depth = d.depth;
						if (depth){
						   	return color(depth);
						}else{
						   	return "#ccc";
						}
					})
					.style("opacity", 0.85)
					.on("mouseover", function(d){
						d3.select(this).attr("r", 10);
						d3.select(this).attr("stroke", "black");
						svg_map.append("text")	
							.attr("id", "tooltip")
					   		.attr("x", parseFloat(projection([d.lon, d.lat])[0]) + 7)
					   		.attr("y", parseFloat(projection([d.lon, d.lat])[1]) - 7)
					   		.attr("text-anchor", "left")
					  		.attr("font-family", "sans-serif")
					  		.attr("font-size", "16px")
					   		.attr("font-weight", "bold")
					  		.attr("fill", "black")
					  		.attr("background", "#FFF4C2")
					   		.text("Well depth: " + d.depth + " metres");	
					})
					.on("mouseout", function(){
						d3.select(this).attr("r", 3);
						d3.select(this).attr("stroke", "none");
						d3.select('#tooltip').remove();
					});

					slider.on("slide", function(evt, value){
						d3.select('#slidertext').text(value);
						wells.attr("r", function(d){
							if(d.year <= value){
								return 3;
							}
				        })

						wellTypes = countWells(data, "type", value);

						var bars1 = svg_chart1.selectAll("rect")
							.data(wellTypes);


						bars1.transition()
							.duration(100)
							.attr("y", function(d) {
								return yType(d.values.count);
							})
							.attr("height", function(d) {
								
								return h2 - yType(d.values.count);
							})

						wellDepths = countWells(data, "depth_bin", value);

						var bars2 = svg_chart2.selectAll("rect")
							.data(wellDepths);


						bars2.transition()
							.duration(100)
							.attr("y", function(d) {
								return yDepth(d.values.count);
							})
							.attr("height", function(d) {
								return h2 - yDepth(d.values.count);
							})

				        var count = 0;
						for (var i = 0; i < data.length; i++) {
							//console.log(data[i].year)
							if(data[i].year <= value){
								count += 1;
					        }
						}
						//console.log(count);
					});
				});

						
		</script>
		</div>
	</div>
	</body>
</html>