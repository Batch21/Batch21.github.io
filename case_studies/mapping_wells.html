<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Adding data points (circles) to the map</title>
		<script type="text/javascript" src="/assets/js/d3.js"></script>
		<script type="text/javascript" src="/assets/js/d3.slider.js"></script>
		<style type="text/css">
		
			circle{
				-moz-transition: all 0.3s;
				-o-transition: all 0.3s;
				-webkit-transition: all 0.3s;
				transition: all 0.5s;
			}
			
			circle:hover {
				fill: blue;
			}

			.con{
				margin: 20px;
				margin-left: 30px;
				width: 100%;
			}

			#slider{
				width: 600px;
			}
	
		</style>
		<link rel="stylesheet" type="text/css" href="/styles.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/d3.slider.css">
	</head>
	<body>
      <div class="con">
      	<header class="masthead">
        	<h3 class="masthead-title">
			Visualising Water Scarity in Andhra Pradesh
        	</h3>
        </header>
        <h2>Year: <span id="slidertext">1970</span></h2>
    	 <div id="slider"></div>
		<script type="text/javascript">

			var slider = d3.slider().axis(true).min(1970).max(2012).value(1970).step(1);

			d3.select('#slider').call(slider);

			//Width and height
			var w = 600;
			var h = 800;

			//Define map projection
			var projection = d3.geo.transverseMercator()
			      				   .rotate([-77.826, -15.381, 0])
			      				   .translate([300, 400])
			      				   .scale(400000);


			//Define path generator
			var path = d3.geo.path()
							 .projection(projection);

			var color = d3.scale.quantize()
								.range(["rgb(248,202,140)", "rgb(240,168,72)","rgb(192,120,96)",
									"rgb(168,96,96)", "rgb(120,72,96)"]);
							 
			
			//Create SVG element
			var svg_map = d3.select(".con")
						.append("svg")
						.attr("width", w)
						.attr("height", h)
						.attr("align", "center");

			d3.json("/assets/data/dhone_area.json", function(json) {
				
				//Bind data and create one path per GeoJSON feature
				svg_map.selectAll("path")
				   .data(json.features)
				   .enter()
				   .append("path")
				   .attr("d", path)
				   .attr("fill", "none")
				   .attr("stroke", "black");

				 });
				   
			d3.csv("/assets/data/dhone_wells.csv", function(data) {

				color.domain([d3.min(data, function(d) { return d.depth; }), 
					d3.max(data, function(d) { return d.depth; })
				]);
						
				var wells = svg_map.selectAll("circle")
				   .data(data)
				   .enter()
				   .append("circle")
				   .attr("cx", function(d) {
						return projection([d.lon, d.lat])[0];
				    })
					.attr("cy", function(d) {
						return projection([d.lon, d.lat])[1];
					})
					.attr("r", function(d){
						if(d.year <= 1970){
							return 3;
						}else{
							return 0;
						}
					})
					.style("fill", function(d){
					   	var depth = d.depth;
						if (depth){
						   	return color(depth);
						}else{
						   	return "#ccc";
						}
					})
					.style("opacity", 0.85)
					.on("mouseover", function(d){
						d3.select(this).attr("r", 10);
						d3.select(this).attr("stroke", "black");
						svg_map.append("text")	
							.attr("id", "tooltip")
					   		.attr("x", parseFloat(projection([d.lon, d.lat])[0]) + 7)
					   		.attr("y", parseFloat(projection([d.lon, d.lat])[1]) - 7)
					   		.attr("text-anchor", "left")
					  		.attr("font-family", "sans-serif")
					  		.attr("font-size", "16px")
					   		.attr("font-weight", "bold")
					  		.attr("fill", "black")
					  		.attr("background", "#FFF4C2")
					   		.text("Well depth: " + d.year + " metres");	
					})
					.on("mouseout", function(){
						d3.select(this).attr("r", 3);
						d3.select(this).attr("stroke", "none");
						d3.select('#tooltip').remove();
					});

					slider.on("slide", function(evt, value){
						d3.select('#slidertext').text(value);
						wells.attr("r", function(d){
										//console.log(value)
										//console.log(d.year)
										//console.log(" ")
										if(d.year <= value){
											return 3;
										}
				                    })
					});
				});	

			

						
		</script>
		</div>
	</div>
	</body>
</html>