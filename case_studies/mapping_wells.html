<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Water Scacity Mapping</title>
		<link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css">
		<script type="text/javascript" src="/assets/js/d3.js"></script>
		<script type="text/javascript" src="/assets/js/d3.slider.js"></script>
		<script type="text/javascript" src="/assets/js/jquery-3.0.0.js"></script>
		<style type="text/css">
		
			.well{
				-moz-transition: all 0.3s;
				-o-transition: all 0.3s;
				-webkit-transition: all 0.3s;
				transition: all 0.5s;
			}
			
			circle:hover {
				fill: blue;
			}
            
            #col{
            	width:100%;
            }

			#slider{
				
				margin-bottom: 40px;
				margin-left: auto;
				margin-right: auto;
			}

			#well-viz-map,
			#well-viz-charts{
				display: inline-block;
			}

			.mapBorder{
				stroke: black;
				fill: none;
				stroke-width: 1;
			}

			.charts{
				display: float;
			}

			.axis path,
			.axis line {
				fill: none;
				stroke: black;
				stroke-width: 0.5;
				shape-margin: crispEdges;
			}

			.axis text {
				font-family: sans-serif;
				font-size: 10px;
			}

	
		</style>
		<link rel="stylesheet" type="text/css" href="/styles.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/d3.slider.css">
	</head>
	<body>
      <div class="container">
       <div class="content">
      	<header>
        <h3>Visualising Water Scarity in Andhra Pradesh </h3>
        </header>
        
    	 <div id="well-viz">
    	 	<h4>Year: <span id="slidertext">1980</span></h4>
    	    <div id="slider"></div>
    	    <div class="well-viz-com">
    	     <div id="well-viz-map"></div>
    	 	 <div id="well-viz-charts" >
    	 		 <div id="well-viz-chart2" class="charts"></div>
    	 		 <div id="well-viz-chart1" class="charts"></div>
    	 	 </div>
    	 	</div>
    	 </div>
    	 <p> The above map shows....</p>
       </div>
		<script type="text/javascript">

			$(function(){

				var $title = $('h3');
				var $para = $('p');
				var $window = $("window");
			
				$title.on('mouseover', function(e){
					console.log(e.pageX);
					$title.css({
						'color': 'red'
					});
				})	

				$title.on("mouseout", function(){
					$title.css({
						'color': 'black'
					});
				})

				$para.on("mouseover", function(e){
					console.log($(window).scrollTop());
				});
			
			});

			var startYear = 1980;
			var sliderYear = 1980;	

			// Add slider
			var slider = d3.slider().axis(true).min(startYear).max(2012).value(startYear).step(1);
			d3.select('#slider').call(slider);

			// Define Widths and heights and margins
			var margin_map = {top: 10, right: 10, bottom: 10, left: 10},
				margin_bar = {top: 10, right: 20, bottom: 50, left: 45};
			var w = 580 - margin_map.left - margin_map.right,
				w2 = 300 - margin_bar.left - margin_bar.right,
			    h = 740 - margin_map.top - margin_map.bottom,
			    h2 = 370 - margin_bar.left - margin_bar.right;

			//Define map projection
			var projection = d3.geo.transverseMercator()
			      				   .rotate([-77.82519, -15.39099, 0])
			      				   .translate([w/2, h/2])
			      				   .scale(420000);


			//Define path generator
			var path = d3.geo.path()
							 .projection(projection);

			var pathWells = d3.geo.path()
							 .projection(projection);




			var color = d3.scale.threshold()
								.domain([10, 50, 100, 300])
								.range(["#FEECAE", "#F0A848","#C07860", "#604860"]);
			
			//Create map SVG elements
			var svg_map = d3.select("#well-viz-map").append("svg")
				.attr("width", w + margin_map.left + margin_map.right)
    			.attr("height", h + margin_map.top + margin_map.bottom)
  				.append("g")
    			.attr("transform", "translate(" + margin_map.left + "," + margin_map.top + ")");

    		svg_map.append("rect")
    			.attr("class", "mapBorder")
    			.attr("x", 0)
    			.attr("y", 0)
    			.attr("height", h)
    			.attr("width", w)


			// Add village boundary to map
			d3.json("/assets/data/dhone_area.json", function(json) {
				
				svg_map.selectAll("path")
				   .data(json.features)
				   .enter()
				   .append("path")
				   .attr("d", path)
				   .attr("fill", "none")
				   .attr("stroke", "black");
				 

            // Create chart SVGs
            var svg_chart1 = d3.select("#well-viz-chart1").append("svg")
						.attr("width", w2 + margin_bar.left + margin_bar.right)
    					.attr("height", h2 + margin_bar.top + margin_bar.bottom)
  						.append("g")
    					.attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");

			var svg_chart2 = d3.select("#well-viz-chart2").append("svg")
						.attr("width", w2 + margin_bar.left + margin_bar.right)
    					.attr("height", h2 + margin_bar.top + margin_bar.bottom)
  						.append("g")
    					.attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");

            // Create chart scales
            xType = d3.scale.ordinal()
            	.rangeRoundBands([0, w2], 0.05);
		 	yType = d3.scale.linear()
		 		.range([h2, 0]);

		 	xDepth = d3.scale.ordinal()
            	.rangeRoundBands([0, w2], 0.05);
		 	yDepth = d3.scale.linear()
		 		.range([h2, 0]);

		 	
			// Add Well Data	   
			d3.csv("/assets/data/dhone_wells.csv", function(data) {

				// Add wells to map		
				var wells = svg_map.selectAll("path")
				   .data(data)
				   .enter()
				   .append("path")
				   .attr("transform", function(d){ return "translate(" + projection([d.lon, d.lat])[0] + "," + projection([d.lon, d.lat])[1] + ")";})
				   .attr("d", d3.svg.symbol()
				   	.size(function(d){
				   		if(d.year <= startYear){
				   			return 30;
				   		} else{
				   			return 0;
				   		}
				   	})
					.type(function(d){
				   		if(d.type === "Open Well"){
				   			return "square";
				   		} else if (d.type === "Agricultural Borewell"){
				   			return "circle";
				   		} else if(d.type === "Domestic Borewell"){
				   			return "triangle-up";
				   		}
				   	}))
					.attr("class", "well")
					.style("fill", function(d){
					   	var depth = d.depth;
						if (depth){
						   	return color(depth);
						}else{
						   	return "#ccc";
						}
					})
					.style("opacity", 0.85)
					.on("mouseover", function(d){
						d3.select(this)
							.style("stroke", "black")
							.attr("d", d3.svg.symbol()
				   			.size(150)
				   			.type(function(d){
				   				if(d.type === "Open Well"){
				   					return "square";
				   				} else if (d.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(d.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
				   		}));
						d3.select(this).attr("stroke", "black");
						svg_map.append("text")	
							.attr("id", "tooltip")
					   		.attr("x", parseFloat(projection([d.lon, d.lat])[0]) + 7)
					   		.attr("y", parseFloat(projection([d.lon, d.lat])[1]) - 7)
					   		.attr("text-anchor", "left")
					  		.attr("font-family", "sans-serif")
					  		.attr("font-size", "16px")
					   		.attr("font-weight", "bold")
					  		.attr("fill", "black")
					   		.text("Well depth: " + d.depth + " metres");	
					})
					.on("mouseout", function(){
						d3.select(this)
							.style("stroke", "none")
							.attr("d", d3.svg.symbol()
				   			.size(35)
				   			.type(function(d){
				   				if(d.type === "Open Well"){
				   					return "square";
				   				} else if (d.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(d.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
				   		}));
						d3.select(this).attr("stroke", "none");
						d3.select('#tooltip').remove();
					});

				// Group data and define scale domains for type bar chart using complete dataset
				var wellTypes = countWells(data, "type", 2012);
				xType.domain(d3.range(wellTypes.length))
				yType.domain([0, d3.max(wellTypes,
				 function(d) { return d.values; })])
				
				// Add axes for type bar chart
				svg_chart1.append("g")
				.attr("class", "y axis")
		 		.call(d3.svg.axis()
		 		.scale(yType)
		 		.orient("left"));

		 		svg_chart1.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0, " + h2 + ")")
		 		.call(d3.svg.axis()
		 		.scale(xType)
		 		.orient("bottom")
		 		.tickFormat(function(d){return wellTypes[d].key;}))
		 		.selectAll(".tick text")
		 			.call(wrap, xType.rangeBand());

		 		// Add axes titles for type chart 
		 		svg_chart1.append("text")
        			.attr("transform", "translate(" + (w2 / 2) + " ," + (h2 + margin_bar.bottom - 5) + ")")
        			.style("text-anchor", "middle")
        			.style("font-size", "12px")
        			.style("font-weight", "bold")
        			.text("Well Type")

        		svg_chart1.append("text")
        			.attr("transform", "rotate(-90)")
        			.attr("y", 0 - margin_bar.left + 10)
        			.attr("x",0 - (h2 / 2))
        			.style("text-anchor", "middle")
        			.style("font-size", "12px")
        			.style("font-weight", "bold")
        			.text("Number of Wells");

        		// Regroup data	for start year
                wellTypes = countWells(data, "type", startYear);

                // Add bars for type chart
				var chart1 = svg_chart1.selectAll("rect")
			   		.data(wellTypes)		
			   		.enter()
			   		.append("rect")
			   		.attr("x", function(d, i) {
			   			return xType(i);
			   		})
			   		.attr("y", function(d) {
			   			return yType(d.values);
			   		})
			   		.attr("width", xType.rangeBand())
			   		.attr("height", function(d) {
			   			return h2 - yType(d.values);
			   		})
			   		.style("fill", function(d){
			   			if(d.key === "Open Well"){
			   				return "#C4ED68"
			   			} else if(d.key === "Agricultural Borewell"){
			   				return "#59A80F"
			   			} else if(d.key === "Domestic Borewell"){
			   				return "1E9EB8"
			   			}
			   		})
			   		.style("opacity", 0.7)
			   		.on("mouseover", function(d){
							d3.select(this)
							//.style("stroke", "black")
							.style("opacity", 1);

							svg_map.selectAll(".well")
							.style("stroke", function(j){
								if(j.year <= sliderYear & d.key === j.type){
									return "black";
								}
							})
							.attr("d", d3.svg.symbol()
				   			.size(function(j){
				   				if (j.year <= sliderYear){
				   					if(d.key === j.type){
				   						return 40;
				   					}else{
				   						return 0;
				   					}
				   				}else{
				   					return 0;
				   				}
				   			})
				   			.type(function(j){
				   				if(j.type === "Open Well"){
				   					return "square";
				   				} else if (j.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(j.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
							}));
					})
					.on("mouseout", function(d){
							d3.select(this)
							//.style("stroke", "none")
							.style("opacity", 0.7);

							svg_map.selectAll(".well")
							.style("stroke", "none")
							.attr("d", d3.svg.symbol()
				   			.size(function(j){
				   				if(j.year <= sliderYear){
				   					return 30;
				   				}else{
				   					return 0;
				   				}
				   			})
				   			.type(function(j){
				   				if(j.type === "Open Well"){
				   					return "square";
				   				} else if (j.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(j.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
							}));
					});

			   	// Group data and define scale domains for depth bar chart using complete dataset
			   	var wellDepths = countWells(data, "depth_bin", 2012);
				xDepth.domain(d3.range(wellDepths.length))
				yDepth.domain([0, d3.max(wellDepths,
					function(d) {return d.values; })])
				
				// Add axes for depth bar chart
				svg_chart2.append("g")
				.attr("class", "y axis")
		 		.call(d3.svg.axis()
		 		.scale(yDepth)
		 		.orient("left"));

		 		svg_chart2.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0, " + h2 + ")")
		 		.call(d3.svg.axis()
		 		.scale(xDepth)
		 		.orient("bottom")
		 		.tickFormat(function(d){return wellDepths[d].key;}));

		 		// Add axes titles for depth chart 
		 		svg_chart2.append("text")
        			.attr("transform", "translate(" + (w2 / 2) + " ," + (h2 + margin_bar.bottom - 15) + ")")
        			.style("text-anchor", "middle")
        			.style("font-size", "12px")
        			.style("font-weight", "bold")
        			.text("Well Depth (metres)")

        		svg_chart2.append("text")
        			.attr("transform", "rotate(-90)")
        			.attr("y", 0 - margin_bar.left + 10)
        			.attr("x",0 - (h2 / 2))
        			.style("text-anchor", "middle")
        			.style("font-size", "12px")
        			.style("font-weight", "bold")
        			.text("Number of Wells");

        		// Regroup data	for start year	
				wellDepths = countWells(data, "depth_bin", startYear);
				
				// Add bars for depth chart
				var chart2 = svg_chart2.selectAll("rect")
			   		.data(wellDepths)		
			   		.enter()
			   		.append("rect")
			   		.attr("x", function(d, i) {
			   			return xDepth(i);
			   		})
			   		.attr("y", function(d) {
			   			return yDepth(d.values);
			   		})
			   		.attr("width", xDepth.rangeBand())
			   		.attr("height", function(d) {
			   			return h2 - yDepth(d.values);
			   		})
			   		.style("fill", function(d){
			   			if(d.key === "0 - 10"){
			   				return "#F8CA8C";
			   			} else if (d.key === "10 - 50"){
			   				return "#F0A848";
			   			} else if (d.key === "50 - 100"){
			   				return "#C07860";
			   			} else if(d.key === "100 +"){
			   				return "#604860";
			   			}
			   		})
			   		.style("opacity", 0.7)
			   		.on("mouseover", function(d){
							d3.select(this)
							.style("opacity", 1);

							svg_map.selectAll(".well")
							.style("stroke", function(j){
								if(j.year <= sliderYear & d.key === j.depth_bin){
									return "black";
								}
							})
							.attr("d", d3.svg.symbol()
				   			.size(function(j){
				   				if (j.year <= sliderYear){
				   					if(d.key === j.depth_bin){
				   						return 40;
				   					}else{
				   						return 0;
				   					}
				   				}else{
				   					return 0;
				   				}
				   			})
				   			.type(function(j){
				   				if(j.type === "Open Well"){
				   					return "square";
				   				} else if (j.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(j.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
							}));
					})
					.on("mouseout", function(d){
							d3.select(this)
							.style("opacity", 0.7);

							svg_map.selectAll(".well")
							.style("stroke", "none")
							.attr("d", d3.svg.symbol()
				   			.size(function(j){
				   				if(j.year <= sliderYear){
				   					return 30;
				   				}else{
				   					return 0;
				   				}
				   			})
				   			.type(function(j){
				   				if(j.type === "Open Well"){
				   					return "square";
				   				} else if (j.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(j.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
							}));
					});

					// slider event 
					slider.on("slide", function(evt, value){
						
						sliderYear = value;
						// update wells on map
						d3.select('#slidertext').text(value);
						wells.attr("d", d3.svg.symbol()
							.size(function(d){
								if(d.year <= value){
									return 30;
								} else{
									return 0;
								}
							})
							.type(function(d){
				   				if(d.type === "Open Well"){
				   					return "square";
				   				} else if (d.type === "Agricultural Borewell"){
				   					return "circle";
				   				} else if(d.type === "Domestic Borewell"){
				   					return "triangle-up";
				   				}
				   			}))

						// Update type chart
						wellTypes = countWells(data, "type", value);
						var bars1 = svg_chart1.selectAll("rect")
							.data(wellTypes);
						bars1.transition()
							.duration(100)
							.attr("y", function(d) {
								return yType(d.values);
							})
							.attr("height", function(d) {
								return h2 - yType(d.values);
							})

						//Update depth chart	
						wellDepths = countWells(data, "depth_bin", value);
						var bars2 = svg_chart2.selectAll("rect")
							.data(wellDepths);
						bars2.transition()
							.duration(100)
							.attr("y", function(d) {
								return yDepth(d.values);
							})
							.attr("height", function(d) {
								return h2 - yDepth(d.values);
							})

					});
						
				});
			});

	function countWells(data, attr, year){
					
					var nested = d3.nest()
                    	.key(function(d) {
                        	return d[attr];
                        	})
                    	.rollup(function(wells) {

                        	var count = d3.sum(wells, function(d) {
                        		if(d['year'] <= year){;
                            		return d['count'];
                            	}		
                        });
                        return count;
                    })
                    .entries(data);
                    return nested;
                }

    function wrap(text, width) {
  		text.each(function() {
    	var text = d3.select(this),
        	words = text.text().split(/\s+/).reverse(),
        	word,
        	line = [],
        	lineNumber = 0,
        	lineHeight = 1.1, // ems
        	y = text.attr("y"),
        	dy = parseFloat(text.attr("dy")),
        	tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    	while (word = words.pop()) {
      		line.push(word);
      		tspan.text(line.join(" "));
      		if (tspan.node().getComputedTextLength() > width) {
        	line.pop();
        	tspan.text(line.join(" "));
        	line = [word];
        	tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}

						
		</script>
		</div>
	</div>
	</body>
</html>